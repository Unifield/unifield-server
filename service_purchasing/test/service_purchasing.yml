- 
  Creating a res.partner record
- 
  !record {model: res.partner, id: res_partner_a0}:
    credit_limit: 0.0
    debit_limit: 0.0
    name: A
    supplier: true
    
- 
  Creating a res.partner.address record
- 
  !record {model: res.partner.address, id: res_partner_address_0}:
    partner_id: res_partner_a0
    street: A

- 
  Creating a product.product record service with reception
- 
  !record {model: product.product, id: product_service_p0}:
    default_code: P0
    name: product 0 test
    type: service
    
- 
  Creating a product.product record service with reception
- 
  !record {model: product.product, id: product_service_recep_p1}:
    default_code: P0
    name: product 0 test
    type: service_recep
    
- 
  Creating a product.product record stockable
- 
  !record {model: product.product, id: product_stockable_p2}:
    default_code: P1
    name: product 1 test
    type: product
    
- 
  First. I create a purchase order with a service product.
  The purchase order is then converted to purchase order
  and validated. No incoming shipment are created because
  only Service product present in the purchase order.
  
  Creating a purchase.order record
- 
  !record {model: purchase.order, id: purchase_order_po0}:
    partner_id: res_partner_a0
    partner_address_id: res_partner_address_0
    pricelist_id: product.list0
    location_id: stock.stock_location_stock
    categ: log
    
- 
  Creating a purchase.order.line record for service product
- 
  !record {model: purchase.order.line, id: purchase_order_line_p00}:
    order_id: purchase_order_po0
    price_unit: 1.0
    product_id: product_service_p0
    product_uom: product.product_uom_unit
    
-

  I validate the purchase order and check that no Incoming shipment has been created

-
  !python {model: purchase.order}: |
    import netsvc
    wf_service = netsvc.LocalService("workflow")
    wf_service.trg_validate(uid, 'purchase.order', ref("purchase_order_po0"), 'purchase_confirm', cr)
    wf_service.trg_validate(uid, 'purchase.order', ref("purchase_order_po0"), 'purchase_approve', cr)
    
    pick_obj = self.pool.get('stock.picking')
    ids = pick_obj.search(cr, uid, [('purchase_id', '=', ref("purchase_order_po0"))], context=context)
    assert len(ids) == 0, 'An incoming shipment is found, no incoming shipment should have been created with service product (0 - %s)'%len(ids)

-
  Secondly. I create a purchase order with a stockable product, a service with reception product,
  and a service product. After validation process, an incoming shipment is created
  with two stock moves, one for the stockable and one for the service with reception product.
  
  Creating a purchase.order record
- 
  !record {model: purchase.order, id: purchase_order_po1}:
    partner_id: res_partner_a0
    partner_address_id: res_partner_address_0
    pricelist_id: product.list0
    location_id: stock.stock_location_stock
    categ: log
    
- 
  Creating a purchase.order.line record for service product
- 
  !record {model: purchase.order.line, id: purchase_order_line_p01}:
    order_id: purchase_order_po1
    price_unit: 1.0
    product_id: product_service_p0
    product_uom: product.product_uom_unit

- 
  Creating a purchase.order.line record for service with reception product
- 
  !record {model: purchase.order.line, id: purchase_order_line_p02}:
    order_id: purchase_order_po1
    price_unit: 1.0
    product_id: product_service_recep_p1
    product_uom: product.product_uom_unit

- 
  Creating a purchase.order.line record for service with stockable product
- 
  !record {model: purchase.order.line, id: purchase_order_line_p03}:
    order_id: purchase_order_po1
    price_unit: 1.0
    product_id: product_stockable_p2
    product_uom: product.product_uom_unit

-

  I validate the purchase order and check that no Incoming shipment has been created and
  contains the two correct stock moves

-
  !python {model: purchase.order}: |
    import netsvc
    wf_service = netsvc.LocalService("workflow")
    wf_service.trg_validate(uid, 'purchase.order', ref("purchase_order_po1"), 'purchase_confirm', cr)
    wf_service.trg_validate(uid, 'purchase.order', ref("purchase_order_po1"), 'purchase_approve', cr)
    
    pick_obj = self.pool.get('stock.picking')
    ids = pick_obj.search(cr, uid, [('purchase_id', '=', ref("purchase_order_po1"))], context=context)
    assert len(ids) == 1, 'No incoming shipment found, an incoming shipment should have been created with service with reception and stockable product (0 - %s)'%len(ids)
    
    pick = pick_obj.browse(cr, uid, ids[0], context=context)
    # the category must be log
    assert pick.order_category == 'log', "the order category does not correspond to purchase order category (log - %s)"%pick.order_category
    count = 0
    for move in pick.move_lines:
      count += 1
      assert move.product_id.id in (ref("product_service_recep_p1"), ref("product_stockable_p2")), "product of stock move is not correct (%s, %s) - %s"%(ref("product_service_recep_p1"), ref("product_stockable_p2"), move.product_id.id) 

    assert count == 2, "the number of stock moves is wrong 2 - %s"%count
