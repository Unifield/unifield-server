-
    In order to test the procurement list module, I will create 6 suppliers,
    5 products and 3 procurement request.
    After, I try all possibility to test the supplier default selection
-
    I create the 6 partners
-
    I create supplier S1
-
  !record {model: res.partner, id: supplier1}:
    name: S1
    supplier: True
    address:
      - name: S1
-
    I create the supplier S2
-
  !record {model: res.partner, id: supplier2}:
    name: S2
    supplier: True
    address:
      - name: S2
-
    I create the supplier S3
-
  !record {model: res.partner, id: supplier3}:
    name: S3
    supplier: True
    address:
      - name: S3
-
    I create the supplier S4
-
  !record {model: res.partner, id: supplier4}:
    name: S4
    supplier: True
    address:
      - name: S4
-
    I create the supplier S5
-
  !record {model: res.partner, id: supplier5}:
    name: S5
    supplier: True
    address:
      - name: S5
-
    I create the supplier S6
-
  !record {model: res.partner, id: supplier6}:
    name: S6
    supplier: True
    address:
      - name: S6
-
    I create the product P1
    In order to test the procurement list module, I start by creating a new product category
-
  !record {model: product.category, id: product_cat1}:
    name: Categ1
-
    I create new product 'P1'
-
  !record {model: product.product, id: product1}:
    categ_id: product_cat1
    cost_method: standard
    mes_type: fixed
    name: P1
    price_margin: 2.0
    procure_method: make_to_stock
    property_stock_inventory: stock.location_inventory
    property_stock_procurement: stock.location_procurement
    property_stock_production: stock.location_production
    seller_delay: '1'
    standard_price: 100.0
    supply_method: buy
    type: product
    uom_id: product.product_uom_unit    
    uom_po_id: product.product_uom_unit
    volume : 0.0
    warranty: 0.0
    weight: 0.0
    weight_net: 0.0
    seller_ids:
      - sequence: 10
        min_qty: 0.00
        name: supplier1
      - sequence: 20
        min_qty: 0.00
        name: supplier2
      - sequence: 30
        min_qty: 0.00
        name: supplier3
-
    I create a second product, P2
-
  !record {model: product.product, id: product2}:
    categ_id: product_cat1
    cost_method: standard
    mes_type: fixed
    name: P2
    price_margin: 2.0
    procure_method: make_to_stock
    property_stock_inventory: stock.location_inventory
    property_stock_procurement: stock.location_procurement
    property_stock_production: stock.location_production
    seller_delay: '1'
    standard_price: 100.0
    supply_method: buy
    type: product
    uom_id: product.product_uom_unit    
    uom_po_id: product.product_uom_unit
    volume : 0.0
    warranty: 0.0
    weight: 0.0
    weight_net: 0.0
    seller_ids:
      - sequence: 10
        min_qty: 0.00
        name: supplier2
      - sequence: 20
        min_qty: 0.00
        name: supplier1
-
    I create the product P3
-
  !record {model: product.product, id: product3}:
    categ_id: product.cat0
    cost_method: standard
    mes_type: fixed
    name: P3
    price_margin: 2.0
    procure_method: make_to_stock
    property_stock_inventory: stock.location_inventory
    property_stock_procurement: stock.location_procurement
    property_stock_production: stock.location_production
    seller_delay: '1'
    standard_price: 100.0
    supply_method: buy
    type: product
    uom_id: product.product_uom_unit    
    uom_po_id: product.product_uom_unit
    volume : 0.0
    warranty: 0.0
    weight: 0.0
    weight_net: 0.0
    seller_ids:
      - sequence: 10
        min_qty: 0.00
        name: supplier3
-
    I create the product P4
-
  !record {model: product.product, id: product4}:
    categ_id: product.cat0
    cost_method: standard
    mes_type: fixed
    name: P4
    price_margin: 2.0
    procure_method: make_to_stock
    property_stock_inventory: stock.location_inventory
    property_stock_procurement: stock.location_procurement
    property_stock_production: stock.location_production
    seller_delay: '1'
    standard_price: 100.0
    supply_method: buy
    type: product
    uom_id: product.product_uom_unit    
    uom_po_id: product.product_uom_unit
    volume : 0.0
    warranty: 0.0
    weight: 0.0
    weight_net: 0.0
    seller_ids:
      - sequence: 10
        min_qty: 0.00
        name: supplier3
      - sequence: 20
        min_qty: 0.00
        name: supplier4
-
    I create the product P5
-
  !record {model: product.product, id: product5}:
    categ_id: product.cat0
    cost_method: standard
    mes_type: fixed
    name: P5
    price_margin: 2.0
    procure_method: make_to_stock
    property_stock_inventory: stock.location_inventory
    property_stock_procurement: stock.location_procurement
    property_stock_production: stock.location_production
    seller_delay: '1'
    standard_price: 100.0
    supply_method: buy
    type: product
    uom_id: product.product_uom_unit    
    uom_po_id: product.product_uom_unit
    volume : 0.0
    warranty: 0.0
    weight: 0.0
    weight_net: 0.0
    seller_ids:
      - sequence: 10
        min_qty: 0.00
        name: supplier4
      - sequence: 20
        min_qty: 0.00
        name: supplier5
-
    I create a procurement list for these two products 
-
  !record {model: procurement.list, id: list1}:
    requestor: Administration
    warehouse_id: stock.warehouse0
    origin: R 20043
-
    I create a Procurement Request Line 1 for list1 
-
  !record {model: procurement.list.line, id: list1_line1}:
    product_id: product1
    product_uom_id: product.product_uom_unit
    product_qty: 12.0
    comment: special comment
    from_stock: False
    list_id: list1
-
    I create a Procurement Request Line 2 for list1 
-
  !record {model: procurement.list.line, id: list1_line2}:
    product_id: product2
    product_uom_id: product.product_uom_unit
    product_qty: 50.0
    from_stock: True
    list_id: list1
-
    I create a second Procurement Request
-
  !record {model: procurement.list, id: list2}:
    requestor: Administration
    warehouse_id: stock.warehouse0
-
  I create Procurement Request line 1 for list2 
-
  !record {model: procurement.list.line, id: list2_line1}:
    product_id: product3
    product_uom_id: product.product_uom_unit
    product_qty: 20.0
    list_id: list2
-
  I create Procurement Request line 2 for list2 
-
  !record {model: procurement.list.line, id: list2_line2}:
    product_id: product4
    product_uom_id: product.product_uom_unit
    product_qty: 30.0
    list_id: list2
-
    I create a third Procurement Request
-
  !record {model: procurement.list, id: list3}:
    requestor: Administration
    warehouse_id: stock.warehouse0
    origin: R 20045
-
    I create a Procurement Request Line 1 for list3
-
  !record {model: procurement.list.line, id: list3_line1}:
    product_id: product5
    product_uom_id: product.product_uom_unit
    product_qty: 30.0
    list_id: list3
-
    I check that the list which was initially in the draft state
-
  !assert {model: procurement.list, id: list1}:
    - state == 'draft'
    - requestor == 'Administration'
    - origin == 'R 20043'
-
    I create a Wizard to create PO
-
  !record {model: procurement.choose.supplier, id: choose1}:
    list_id: list1
    line_ids:
      - product_id: product1
        product_uom: product.product_uom_unit
        product_qty: 12.0
        line_id: list1_line1
        supplier_id: supplier1
      - product_id: product2
        product_uom: product.product_uom_unit
        product_qty: 10.0
        line_id: list1_line2 
        supplier_id: supplier2
-
    I check if the creation of PO is ok
-
  !python {model: procurement.choose.supplier}: |
    choose_obj = self.pool.get('procurement.choose.supplier')
    choose_obj.create_po(cr, uid, [ref('choose1')])
-
    I check if the creation of RfQ is ok
-
  !record {model: procurement.choose.supplier.rfq, id: supplier_choose1}:
    choose_id: choose1
    supplier_ids:
      - supplier1
      - supplier2
      - supplier3
-
    I confirm the creation of RfQ
-
  !python {model: procurement.choose.supplier.rfq}: |
    sup_obj = self.pool.get('procurement.choose.supplier.rfq')
    sup_obj.create_rfq(cr, uid, [ref('supplier_choose1')])
-
    I check if the latest message in procurement line is 'RfQ In Progress'
-
  !assert {model: procurement.list.line, id: list1_line1}:
    - latest == 'RfQ In Progress', "Rfq In Progress not applied in latest field of line"
-
    I check if only one RfQ will be created for the line
-
  !python {model: procurement.list}: |
    list1 = self.browse(cr, uid, ref('list1'))
    pol_obj = self.pool.get('purchase.order.line')
    order_obj = self.pool.get('purchase.order')

    list_line_ids = []
    for line in list1.line_ids:
        list_line_ids.append(line.id)

    pol_ids = pol_obj.search(cr, uid, [('product_id', '=', ref('product1')), ('procurement_line_id', 'in', list_line_ids)])

    for pol in pol_obj.browse(cr, uid, pol_ids):
        assert pol.order_id.origin == pl.name, "Bad name for the name of the generated Purchase Order"
        print pol.procurement_line_id.latest, pol.order_id.name
        order_obj.wkf_confirm_order(cr, uid, [pol.order_id.id])
        print pol.procurement_line_id.latest, pol.order_id.name
        assert pol.procurement_line_id.latest == pol.order_id.name, "Procurement line not updated"
-
    I check that no purchase order line with P2
-
  !python {model: procurement.list}: |
    list1 = self.browse(cr, uid, ref('list1'))
    pol_obj = self.pool.get('purchase.order.line')
    list_line_ids = []
    for line in list1.line_ids:
        list_line_ids.append(line.id)
    pol_ids = pol_obj.search(cr, uid, [('product_id', '=', ref('product2')), ('procurement_line_id', 'in', list_line_ids)])
    assert len(pol_ids) == 0, "Purchase order line found !"
