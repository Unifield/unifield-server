<?xml version="1.0" encoding="UTF-8"?>
<openerp>
    <data>
        <!-- Here we just add a boolean in the page 'Delivery and invoicing' of the purchase order form notebook -->
        <record id="purchase_cross_docking_form_view" model="ir.ui.view">
            <field name="name">purchase.cross.docking.form.view</field>
            <field name="model">purchase.order</field>
            <field name="type">form</field>
            <field name="priority">301</field>
            <field name="inherit_id" ref="purchase.purchase_order_form" />
            <field name="arch" type="xml">
                <data>
                    <xpath expr="/form/notebook/page[@string='Delivery &amp; Invoicing']/group/field[@name='location_id']" position="before" >
                        <field name="cross_docking_ok" attrs="{'readonly':[('state','in', ['confirmed','approved','done'] )]}" 
                        on_change="onchange_cross_docking_ok(cross_docking_ok)"
                        />
                    </xpath>
                    <field name="location_id" position= "replace">
                        <field name="location_id" attrs="{'readonly':['|', '|', ('state', 'not in', ['draft', 'confirmed']), ('warehouse_id', '!=', False), ('cross_docking_ok','=', True)]}"/>
                    </field>
                </data>
            </field>
        </record>
        
        <!-- Here we add 'purchase_id' in the context for defining a 'default_get'
         when we want to create a new stock move directly in the delivery form -->
        <record id="stock_picking_cross_docking_form_view" model="ir.ui.view">
            <field name="name">stock.picking.in.form.cross.docking</field>
            <field name="model">stock.picking</field>
            <field name="type">form</field>
            <field name="priority">16</field>
            <field name="inherit_id" ref="stock.view_picking_in_form" />
            <field name="arch" type="xml">
                <data>
                    <xpath expr="/form/notebook/page[@string='General Information']/field[@name='move_lines']" position="attributes" >
                        <attribute name="context">{'purchase_id': purchase_id} </attribute>
                    </xpath>
                </data>
            </field>
        </record>
        
        <!-- Delivery Orders : we add 2 buttons and play with attrs to change the source location-->
        <record id="view_picking_out_cross_docking_form" model="ir.ui.view">
            <field name="name">view.picking.out.cross.docking</field>
            <field name="model">stock.picking</field>
            <field name="type">form</field>
            <field name="priority">16</field>
            <field name="inherit_id" ref="stock.view_picking_out_form" />
            <field name="arch" type="xml">
                <data>
                    <xpath expr="//tree[@string='Stock Moves']//field[@name='location_id']" position="after" >
                        <button name="button_cross_docking" string="Cross docking" type="object" icon="gtk-select-color"  
                        attrs="{'invisible':['|', ('move_cross_docking_ok','=', True), ('state', 'in', ('done','cancel'))]}" />
                        <button name="button_stock" string="Stock" type="object" icon="gtk-media-play"  
                        attrs="{'invisible':['|', ('move_cross_docking_ok','=', False), ('state', 'in', ('done','cancel'))]}" />
                        <field name="move_cross_docking_ok" invisible='1'/>
                    </xpath>
                    <xpath expr="/form/notebook/page[@string='Products']/group/field[@name='state']" position="after" >
                        <button name="button_cross_docking_all" string="Cross docking" type="object" icon="gtk-select-color"  
                        attrs="{'invisible':['|', ('cross_docking_ok','=', True), ('state', 'in', ('done','cancel'))]}" />
                        <button name="button_stock_all" string="Stock" type="object" icon="gtk-media-play"  
                        attrs="{'invisible':['|', ('cross_docking_ok','=', False), ('state', 'in', ('done','cancel'))]}" />
                        <field name="cross_docking_ok" invisible='1' />
                    </xpath>
                </data>
            </field>
        </record>
        
        <!-- Picking Tickets (same feature as delivery order): we add 2 buttons and play with attrs to change the source location -->
        <record id="view_picking_ticket_cross_docking_form" model="ir.ui.view">
            <field name="name">picking.ticket.cross.docking</field>
            <field name="model">stock.picking</field>
            <field name="type">form</field>
            <field name="priority">16</field>
            <field name="inherit_id" ref="msf_outgoing.view_picking_ticket_form" />
            <field name="arch" type="xml">
                <data>
                    <xpath expr="//tree[@string='Stock Moves']//field[@name='location_id']" position="after" >
                        <button name="button_cross_docking" string="Cross docking" type="object" icon="gtk-select-color"  
                        attrs="{'invisible':['|', ('move_cross_docking_ok','=', True), ('state', 'in', ('done','cancel'))]}" />
                        <button name="button_stock" string="Stock" type="object" icon="gtk-media-play"  
                        attrs="{'invisible':['|', ('move_cross_docking_ok','=', False), ('state', 'in', ('done','cancel'))]}" />
                        <field name="move_cross_docking_ok" invisible='1'/>
                    </xpath>
                    <xpath expr="/form/notebook/page[@string='Products']/group/field[@name='state']" position="after" >
                        <button name="button_cross_docking_all" string="Cross docking" type="object" icon="gtk-select-color"  
                        attrs="{'invisible':['|', ('cross_docking_ok','=', True), ('state', 'in', ('done','cancel'))]}" />
                        <button name="button_stock_all" string="Stock" type="object" icon="gtk-media-play"  
                        attrs="{'invisible':['|', ('cross_docking_ok','=', False), ('state', 'in', ('done','cancel'))]}" />
                        <field name="cross_docking_ok" invisible='1' />
                    </xpath>
                </data>
            </field>
        </record>
        
        <!-- Pre-Packing Lists (same feature as delivery order): we add 2 buttons and play with attrs to change the source location -->
        <record id="view_ppl_cross_docking_form" model="ir.ui.view">
            <field name="name">ppl.cross.docking</field>
            <field name="model">stock.picking</field>
            <field name="type">form</field>
            <field name="priority">16</field>
            <field name="inherit_id" ref="msf_outgoing.view_ppl_form" />
            <field name="arch" type="xml">
                <data>
                    <xpath expr="//tree[@string='Stock Moves']//field[@name='location_id']" position="after" >
                        <button name="button_cross_docking" string="Cross docking" type="object" icon="gtk-select-color"  
                        attrs="{'invisible':['|', ('move_cross_docking_ok','=', True), ('state', 'in', ('done','cancel'))]}" />
                        <button name="button_stock" string="Stock" type="object" icon="gtk-media-play"  
                        attrs="{'invisible':['|', ('move_cross_docking_ok','=', False), ('state', 'in', ('done','cancel'))]}" />
                        <field name="move_cross_docking_ok" invisible='1'/>
                    </xpath>
                    <xpath expr="/form/notebook/page[@string='Products']/group/field[@name='state']" position="after" >
                        <button name="button_cross_docking_all" string="Cross docking" type="object" icon="gtk-select-color"  
                        attrs="{'invisible':['|', ('cross_docking_ok','=', True), ('state', 'in', ('done','cancel'))]}" />
                        <button name="button_stock_all" string="Stock" type="object" icon="gtk-media-play"  
                        attrs="{'invisible':['|', ('cross_docking_ok','=', False), ('state', 'in', ('done','cancel'))]}" />
                        <field name="cross_docking_ok" invisible='1' />
                    </xpath>
                </data>
            </field>
        </record>
         
    </data>
</openerp>