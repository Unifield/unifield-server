<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>

        <!--
            Debit Note views
        -->

        <!-- Debit note list -->
        <record id="view_debit_note_tree" model="ir.ui.view">
            <field name="name">Debit Note</field>
            <field name="model">account.invoice</field>
            <field name="type">tree</field>
            <field name="priority">19</field>
            <field name="arch" type="xml">
                <tree string="Note" colors="blue:state in ('draft');black:state in ('proforma','proforma2','open');gray:state in ('cancel')">
                    <field name="date_invoice"/>
                    <field name="number"/>
                    <field name="partner_id"/>
                    <field name="name"/>
                    <field name="date_due"/>
                    <field name="origin"/>
                    <field name="currency_id"/>
                    <field name="residual"/>
                    <field name="amount_total"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

        <!-- Debit Note form -->
        <record id="view_debit_note_form" model="ir.ui.view">
            <field name="name">debit.note.form</field>
            <field name="model">account.invoice</field>
            <field name="type">form</field>
            <field name="priority">60</field>
            <field name="arch" type="xml">
                <form string="Debit Note" hide_duplicate_button="1">
                    <group colspan="4" col="8">
                        <field name="journal_id" groups="base.group_user" on_change="onchange_journal_id(journal_id)" widget="selection"/>
                        <field name="number"/>
                        <field name="type" invisible="1"/>
                        <field name="currency_id" width="50"/>
                        <button name="%(account.action_account_change_currency)d" type="action" icon="terp-stock_effects-object-colorize" string="Change" attrs="{'invisible':[('state','!=','draft')]}" groups="account.group_account_user"/>
                        <newline/>
                        <field string="Customer" name="partner_id" on_change="onchange_partner_id(type,partner_id,date_invoice,payment_term, partner_bank_id,company_id)" groups="base.group_user" context="{'search_default_customer': 1}"/>
                        <field domain="[('partner_id','=',partner_id)]" name="address_invoice_id"/>
                        <newline/>
                        <field name="date_invoice"/>
                        <field name="period_id" domain="[('state', '=', 'draft')]" groups="account.group_account_user" widget="selection"/>
                        <group colspan="2" col="1" groups="account.group_account_user">
                            <label align="0.0" string="(keep empty to use the current period)"/>
                        </group>
                    </group>
                    <group colspan="4" col="8">
                        <button name="button_debit_note_import_invoice" string="Import invoice" states="draft" type="object" icon="gtk-save-as" colspan="2" 
                            help="Import invoice that come from the default account given in Company configuration ('Import invoice default account for Debit Note')"/>
                        <group colspan="2"/>
                    </group>
                    <notebook colspan="4">
                        <page string="Invoice">
                            <field domain="[('company_id', '=', company_id),('type','=', 'receivable')]" name="account_id" groups="account.group_account_user"/>
                            <field name="name"/>
                            <field colspan="4" name="invoice_line" nolabel="1" widget="one2many_list">
                                <tree editable="top" string="Invoice Line" noteditable="1" hide_new_button="1">
                                    <field name="name"/>
                                    <field name="account_id" groups="account.group_account_user"/>
                                    <field name="quantity"/>
                                    <field name="uos_id" string="UoM"/>
                                    <field name="price_unit"/>
                                    <field name="price_subtotal"/>
                                </tree>
                            </field>
                            <group col="8" colspan="4">
                                <label string="" colspan="3"/>
                                <field name="reconciled"/>
                                <field name="amount_total"/>
                                <label string="" colspan="3"/>
                                <field name="state"/>
                                <field name="residual"/>
                            </group>
                            <group col="8" colspan="4" groups="base.group_user">
                                <button name="invoice_cancel" states="draft,proforma2,sale,open" string="Cancel" icon="gtk-cancel"/>
                                <button name="%(account.action_account_invoice_refund)d" type='action' string='Refund' states='open,paid' icon="gtk-execute"/>
                                <button name='%(account.action_account_state_open)d' type='action' string='Re-Open' states='paid' icon="gtk-convert" groups="base.group_no_one"/>
                                <button name="invoice_open" states="draft,proforma2" string="Validate" icon="gtk-go-forward"/>
                                <button name="%(account.account_invoices)d" string="Print Invoice" type="action" icon="gtk-print" states="open,paid,proforma,sale,proforma2"/>
                            </group>
                        </page>
                        <page string="Other Info">
                            <field name="company_id" on_change="onchange_company_id(company_id,partner_id,type,invoice_line,currency_id)" widget="selection" groups="base.group_multi_company"/>
                            <newline/>
                            <field name="date_due"/>
                            <field name="user_id"/>
                            <newline/>
                            <field domain="[('partner_id.ref_companies', 'in', [company_id])]" name="partner_bank_id"
                                groups="base.group_extended"/>
                            <field name="origin"/>
                            <field colspan="4" domain="[('partner_id','=',partner_id)]" name="address_contact_id"
                                groups="base.group_extended"/>
                            <field name="move_id" groups="account.group_account_user"/>
                            <separator colspan="4" string="Additional Information"/>
                            <field colspan="4" name="comment" nolabel="1"/>
                        </page>
                        <page string="Payments">
                            <field name="payment_ids" colspan="4" nolabel="1">
                                <tree string="Payments">
                                    <field name="date"/>
                                    <field name="ref"/>
                                    <field name="name"/>
                                    <field name="journal_id" groups="base.group_user"/>
                                    <field name="debit"/>
                                    <field name="credit"/>
                                    <field name="amount_currency"/>
                                    <field name="currency_id"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </form>
            </field>
        </record>

        <!--
            In-kind Donation views
        -->

        <!-- In-kind Donation list -->
        <record id="view_inkind_donation_tree" model="ir.ui.view">
            <field name="name">inkind.donation.form</field>
            <field name="model">account.invoice</field>
            <field name="type">tree</field>
            <field name="priority">19</field>
            <field name="arch" type="xml">
                <tree string="In-kind Donation" colors="blue:state in ('draft');black:state in ('proforma','proforma2','open');gray:state in ('cancel')">
                    <field name="date_invoice" string="Donation certificate"/>
                    <field name="number"/>
                    <field name="partner_id"/>
                    <field name="name"/>
                    <field name="origin"/>
                    <field name="currency_id"/>
                    <field name="amount_total"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

        <!-- In-kind Donation form -->
        <record id="view_inkind_donation_form" model="ir.ui.view">
            <field name="name">inkind.donation.form</field>
            <field name="model">account.invoice</field>
            <field name="type">form</field>
            <field name="priority">60</field>
            <field name="arch" type="xml">
                <form string="In-kind Donation" hide_duplicate_button="1">
                    <group colspan="4" col="8">
                        <field name="journal_id" groups="base.group_user" on_change="onchange_journal_id(journal_id)" widget="selection"/>
                        <field name="number"/>
                        <field name="type" invisible="1"/>
                        <field name="currency_id" width="50"/>
                        <button name="%(account.action_account_change_currency)d" type="action" icon="terp-stock_effects-object-colorize" string="Change" attrs="{'invisible':[('state','!=','draft')]}" groups="account.group_account_user"/>
                        <newline/>
                        <field string="Donor" name="partner_id" on_change="onchange_partner_id(type,partner_id,date_invoice,payment_term, partner_bank_id,company_id)" groups="base.group_user" context="{'search_default_customer': 1}"/>
                        <field domain="[('partner_id','=',partner_id)]" name="address_invoice_id" string="Address"/>
                        <newline/>
                        <field name="date_invoice" string="Donation certificate date"/>
                        <field name="period_id" domain="[('state', '=', 'draft')]" groups="account.group_account_user" widget="selection"/>
                        <group colspan="2" col="1" groups="account.group_account_user">
                            <label align="0.0" string="(keep empty to use the current period)"/>
                        </group>
                        <button name="button_analytic_distribution" string="Analytical Distribution" type="object" icon="terp-check" context="context" colspan="2" attrs="{'invisible': [('analytic_distribution_id', '=', False)]}"/>
                        <button name="button_analytic_distribution" string="Analytical Distribution" type="object" icon="terp-emblem-important" context="context" colspan="2" attrs="{'invisible': [('analytic_distribution_id', '!=', False)]}"/>
                        <field name="analytic_distribution_id" invisible="1"/>
                        <group colspan="2"/>
                    </group>
                    <notebook colspan="4">
                        <page string="Invoice">
                            <field domain="[('company_id', '=', company_id),('type','=', 'receivable')]" name="account_id" groups="account.group_account_user"/>
                            <field name="reference_type" nolabel="1" size="0"/>
                            <field name="reference" nolabel="1"/>
                            <field name="name"/>
                            <field name="origin"/>
                            <newline/>
                            <label string="" colspan="2"/>
                            <field name="check_total" required="2"/>
                            <field colspan="4" name="invoice_line" nolabel="1" widget="one2many_list">
                                <tree editable="top" string="Donation Lines" noteditable="1" hide_new_button="1">
                                    <field name="line_number"/>
                                    <field name="product_id"/>
                                    <field name="account_id" groups="account.group_account_user"/>
                                    <button name="button_analytic_distribution" string="Analytical Distribution" type="object" icon="terp-stock_symbol-selection" 
                                        context="{'d_journal_id': parent.journal_id , 'd_partner_id': parent.partner_id, 'd_address_invoice_id':parent.address_invoice_id,'d_date_invoice': parent.date_invoice, 'd_register_posting_date': parent.register_posting_date, 'd_account_id': parent.account_id, 'd_partner_bank_id': parent.partner_bank_id, 'd_payment_term': parent.payment_term, 'd_name': parent.name, 'd_origine': parent.origin, 'd_address_contact_id': parent.address_contact_id, 'd_user_id': parent.user_id, 'd_comment': parent.comment}"
                                        />
                                    <field name="analytic_distribution_state_recap" attrs="{'invisible': [('is_allocatable', '=', False)]}"/>
                                    <field name="analytic_distribution_state" invisible="1"/>
                                    <field name="have_analytic_distribution_from_header" invisible="1"/>
                                    <field name="quantity"/>
                                    <field name="price_unit"/>
                                    <field name="price_subtotal"/>
                                    <field name="name"/>
                                </tree>
                            </field>
                            <group col="8" colspan="4">
                                <label string="" colspan="3"/>
                                <field name="reconciled"/>
                                <field name="amount_total"/>
                                <label string="" colspan="3"/>
                                <field name="state"/>
                                <field name="residual"/>
                            </group>
                            <group col="8" colspan="4" groups="base.group_user">
                                <button name="invoice_cancel" states="draft,proforma2,sale,open" string="Cancel" icon="gtk-cancel"/>
                                <button name="%(account.action_account_invoice_refund)d" type='action' string='Refund' states='open,paid' icon="gtk-execute"/>
                                <button name='%(account.action_account_state_open)d' type='action' string='Re-Open' states='paid' icon="gtk-convert" groups="base.group_no_one"/>
                                <button name="invoice_open" states="draft,proforma2" string="Validate" icon="gtk-go-forward"/>
                                <button name="%(account.account_invoices)d" string="Print Invoice" type="action" icon="gtk-print" states="open,paid,proforma,sale,proforma2"/>
                            </group>
                        </page>
                    </notebook>
                </form>
            </field>
        </record>

        <!--
            Delete some elements on customer invoices:
            - fiscal_position field
            - proforma button (invoice_proforma2)
            - payment_term field
            - tax frame
            - compute tax button (button_reset_taxes)
            - amount untaxed field
            - amount tax field
        -->
        <record id="inherit_invoice_form" model="ir.ui.view">
            <field name="name">inherit.invoice.form</field>
            <field name="model">account.invoice</field>
            <field name="type">form</field>
            <field name="inherit_id" ref="account.invoice_form"/>
            <field name="priority">65</field>
            <field name="arch" type="xml">
                <data>
                    <field name="fiscal_position" position="replace"/>
                    <field name="payment_term" position="replace"/>
                    <field name="tax_line" position="replace"/>
                    <button name="button_reset_taxes" position="replace"/>
                    <button name="invoice_proforma2" position="replace"/>
                    <xpath expr="/form/notebook/page[@string='Invoice']/group[2]" position="replace">
                        <group col="8" colspan="4">
                            <label string="" colspan="3"/>
                            <field name="reconciled"/>
                            <field name="amount_total"/>
                            <label string="" colspan="3"/>
                            <field name="state"/>
                            <field name="residual"/>
                            <field name="is_debit_note" invisible="1"/>
                        </group>
                        <group col="8" colspan="4" groups="base.group_user">
                            <button name="invoice_cancel" states="proforma2,open" string="Cancel" icon="gtk-cancel"/>
                            <button name="%(account.action_account_invoice_refund)d" type='action' string='Refund' states='open,paid' icon="gtk-execute"/>
                            <button name='%(account.action_account_state_open)d' type='action' string='Re-Open' states='paid' icon="gtk-convert" groups="base.group_no_one"/>
                            <button name="invoice_open" states="draft,proforma2" string="Validate" icon="gtk-go-forward"/>
                            <button name="%(account.account_invoices)d" string="Print Invoice" type="action" icon="gtk-print" states="open,paid,proforma,sale,proforma2"/>
                        </group>
                    </xpath>
                    <xpath expr="//page[@string='Payments']" position="replace">
                    </xpath>
                </data>
            </field>
        </record>

        <!--
            Debit note actions
        -->

        <!-- Display debit note list (only invoice that have 'is_debit_note' to True)-->
        <record id="action_debit_note" model="ir.actions.act_window">
            <field name="name">Debit Note</field>
            <field name="res_model">account.invoice</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form,calendar,graph</field>
            <field eval="False" name="view_id"/>
            <field name="domain">[('type','=','out_invoice'), ('is_debit_note', '!=', False), ('is_inkind_donation', '=', False)]</field>
            <field name="context">{'type':'out_invoice', 'journal_type': 'sale', 'is_debit_note': True}</field>
            <field name="search_view_id" ref="account.view_account_invoice_filter"/>
        </record>

        <!-- Link between previous action and Debit Note tree view -->
        <record model="ir.actions.act_window.view" id="act_debit_note_tree">
            <field name="sequence" eval="5"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="view_debit_note_tree"/>
            <field name="act_window_id" ref="action_debit_note"/>
        </record>

        <!-- Link between action and Debit Note form view -->
        <record model="ir.actions.act_window.view" id="act_debit_note_form">
            <field name="sequence" eval="10"/>
            <field name="view_mode">form</field>
            <field name="view_id" ref="view_debit_note_form"/>
            <field name="act_window_id" ref="action_debit_note"/>
        </record>

        <!-- Display in-kind donation list (only invoice that have 'is_inkind_donation' to True)-->
        <record id="action_inkind_donation" model="ir.actions.act_window">
            <field name="name">Donation</field>
            <field name="res_model">account.invoice</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form,calendar,graph</field>
            <field eval="False" name="view_id"/>
            <field name="domain">[('type','=','in_invoice'), ('is_debit_note', '=', False), ('is_inkind_donation', '=', True)]</field>
            <field name="context">{'type':'in_invoice', 'journal_type': 'inkind'}</field>
            <field name="search_view_id" ref="account.view_account_invoice_filter"/>
        </record>

        <!-- Link between previous action and In-kind Donation tree view -->
        <record model="ir.actions.act_window.view" id="act_inkind_donation_tree">
            <field name="sequence" eval="6"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="view_inkind_donation_tree"/>
            <field name="act_window_id" ref="action_inkind_donation"/>
        </record>

        <!-- Link between action and In-kind Donation form view -->
        <record model="ir.actions.act_window.view" id="act_inkind_donation_form">
            <field name="sequence" eval="11"/>
            <field name="view_mode">form</field>
            <field name="view_id" ref="view_inkind_donation_form"/>
            <field name="act_window_id" ref="action_inkind_donation"/>
        </record>

        <!-- Fix customer invoice display with a bypass on 'is_debit_note' set to True -->
        <record id="account.action_invoice_tree1" model="ir.actions.act_window">
            <field name="name">Customer Invoices</field>
            <field name="res_model">account.invoice</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form,calendar,graph</field>
            <field eval="False" name="view_id"/>
            <field name="domain">[('type','=','out_invoice'), ('is_debit_note', '=', False), ('is_inkind_donation', '=', False)]</field>
            <field name="context">{'type':'out_invoice', 'journal_type': 'sale'}</field>
            <field name="search_view_id" ref="account.view_account_invoice_filter"/>
            <field name="help">With Customer Invoices you can create and manage sales invoices issued to your customers. OpenERP can also generate draft invoices automatically from sales orders or deliveries. You should only confirm them before sending them to your customers.</field>
        </record>

        <!-- Fix supplier invoice display with a bypass on 'is_inkind_donation' set to True -->
        <record id="account.action_invoice_tree2" model="ir.actions.act_window">
            <field name="name">Supplier Invoices</field>
            <field name="res_model">account.invoice</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form,calendar,graph</field>
            <field eval="False" name="view_id"/>
            <field name="domain">[('type','=','in_invoice'), ('register_line_ids', '=', False), ('is_inkind_donation', '=', False), ('is_debit_note', "=", False)]</field>
            <field name="context">{'type':'in_invoice', 'journal_type': 'purchase'}</field>
            <field name="search_view_id" ref="account.view_account_invoice_filter"/>
            <field name="help">With Supplier Invoices you can enter and manage invoices issued by your suppliers. 
                OpenERP can also generate draft invoices automatically from purchase orders or receipts. This way, you can control the invoice 
                from your supplier according to what you purchased or received.</field>
        </record>

        <!--
            Debit Note Menu
        -->

        <!-- Debit Note Menu in "Customer Invoices" -->
        <menuitem action="action_debit_note" id="menu_action_debit_note" parent="account.menu_finance_receivables" sequence="10"/>

        <!-- In-kind Donation Menu in "Supplier Invoices" -->
        <menuitem action="action_inkind_donation" id="menu_action_inkind_donation" parent="account.menu_finance_payables" sequence="11"/>

        <!--
            Account invoice report redefinition
        -->

        <report
            auto="False"
            id="account.account_invoices"
            model="account.invoice"
            name="account.invoice2"
            rml="account_msf/report/account_print_invoice.rml"
            string="Print report"
            attachment="(object.state in ('open','paid')) and ('INV'+(object.number or '').replace('/',''))"
            attachment_use="1"
            multi="True"/>

    </data>
</openerp>
