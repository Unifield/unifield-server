<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>
        <record id="request_for_quotation_form" model="ir.ui.view">
            <field name="name">request.for.quotation.form</field>
            <field name="model">purchase.order</field>
            <field name="type">form</field>
            <field name="priority">17</field>
            <field name="arch" type="xml">
                <form string="Request for Quotation">
                    <group col="6" colspan="4">
                        <field name="requested_date_in_past" invisible="1" />
                        <group colspan="6">
                            <html>
                                <p id="view_order_requested_in_past"
                                    style="display:none; text-align:center; color:#f27d0c; font-weight:bold; font-size:1.2em">
                                    <translate>WARNING: The requested date of this Request for Quotation is in the past.</translate>
                                    <br />
                                </p>
                                <script language="javascript">
                                    var is_in_past = $('#requested_date_in_past').val();
                                    if (is_in_past == "1") {
                                        msg_dom = $('#view_order_requested_in_past');
                                        msg_dom.show();
                                    }
                                </script>
                            </html>
                        </group>

                        <field name="name"/>
                        <field name="date_order"/>
                        <field name="invoiced"/>
                        <newline/>
                        <field name="warehouse_id" on_change="onchange_warehouse_id(warehouse_id,order_type,dest_address_id)" widget="selection"/>
                        <field name="partner_ref" attrs="{'readonly': ['|', ('partner_type', 'not in', ['external', 'esc']), ('state', 'not in', ['draft', 'validated'])]}"/>
                        <field name="shipped"/>
                        <field name="push_fo" invisible="1"/>
                        <field name="order_type" on_change="onchange_internal_type(order_type, partner_id, categ, dest_partner_id, warehouse_id, delivery_requested_date)" />
                        <field name="priority"/>
                        <newline />
                        <field name="categ" on_change="onchange_categ(categ, warehouse_id, cross_docking_ok, location_id)" />
                        <field name="details" />
                        <field name="parent_order_name" readonly="True" attrs="{'invisible': [('parent_order_name', '=', False)]}" />
                        <newline />
                        <field name="loan_duration" attrs="{'invisible': [('order_type', '!=', 'loan')], 'required': [('order_type', '=', 'loan')]}" />
                        <field name="rfq_delivery_address"/>
                    </group>
                    <notebook colspan="4">
                        <page string="Request for Quotation">
                            <field name="partner_id" on_change="onchange_partner_id(partner_id)" context="{'search_default_supplier':1}" domain="[('id', '!=', company_id)]" />
                            <field name="partner_type"/>
                            <field name="allocation_setup" invisible="1" />
                            <field name="partner_address_id"/>
                            <field name="origin" groups="base.group_extended"/>
                            <field name="internal_type"/>
                            <field name="customer_ref"/>
                            <field name="pricelist_id"/>
                            <button colspan="4" string="Round Qty to SoQ" type="object" name="round_to_soq" icon="gtk-execute" attrs="{'invisible': [('rfq_state', '!=', 'draft')]}" />
                            <newline/>
                            <field colspan="4" name="order_line" nolabel="1" mode="tree,form">
                                <tree string="Lines" hide_delete_button="True">
                                    <field name="line_number"/>
                                    <field name="default_code"/>
                                    <field name="name"/>
                                    <field name="comment"/>
                                    <field name="nomenclature_description"/>
                                    <field name="supplier_code"/>
                                    <field name="product_qty"/>
                                    <field name="product_uom"/>
                                    <field name="date_planned"/>
                                    <field name="confirmed_delivery_date"/>
                                    <field name="kc_dg"/>
                                    <field name="price_unit" invisible="1"/>
                                    <field name="price_subtotal"/>
                                    <field name="currency_id"/>
                                    <field name="tender_line_id" invisible="1" />
                                    <field name="fake_state" invisible="1"/>
                                    <button string="Cancel" icon="gtk-del" type="object" name="ask_unlink" attrs="{'invisible': [('fake_state', 'in', ['cancel', 'cancel_r', 'done'])]}" />
                                </tree>
                            </field>
                            <group col="7" colspan="4">
                                <field name="currency_id"/>
                                <field name="amount_untaxed" sum="Untaxed amount"/>
                                <field name="amount_tax"/>
                                <field name="amount_total" sum="Total amount"/>
                                <button name="button_dummy" string="Compute" attrs="{'invisible': [('rfq_state', '!=', 'draft')]}" type="object" icon="gtk-execute"/>
                                <newline/>
                                <field name="functionnal_currency_id"/>
                                <field name="functionnal_amount_untaxed"/>
                                <field name="functional_amount_tax"/>
                                <field name="functionnal_amount_total"/>
                            </group>
                            <group col="11" colspan="4">
                                <field name="rfq_state" readonly="1"/>
                                <button name="purchase_cancel"  type="object" attrs="{'invisible': [('rfq_state', 'not in', ['draft', 'sent'])]}" string="Cancel" icon="gtk-cancel"/>
                                <button name="rfq_sent" type="object" string="Send RfQ" icon="gtk-go-forward" attrs="{'invisible': [('rfq_state', '!=', 'draft')]}" />
                                <button name="check_rfq_updated" type="object" string="RfQ Updated" icon="gtk-go-forward" attrs="{'invisible': [('rfq_state', '!=', 'sent')]}" />
                            </group>
                        </page>
                        <page string="Notes">
                            <field name="import_in_progress"/>
                            <field colspan="4" name="notes" nolabel="1"/>
                            <separator colspan="4" string="Message ESC" />
                            <field name="message_esc" colspan="4" nolabel="1" readonly="1" attrs="{'invisible': [('partner_type', '!=', 'esc')]}" />
                            <separator colspan="4" string="Project info" />
                            <field name="project_ref" readonly="1" />
                            <separator colspan="4" string="Sourcing group" />
                            <field name="related_sourcing_id"/>
                            <separator colspan="4" string="Import filenames" />
                            <field name="import_filenames"/>
                        </page>
                    </notebook>
                </form>
            </field>
        </record>

        <record id="view_rfq_filter" model="ir.ui.view">
            <field name="name">purchase.order.rfq.list.select</field>
            <field name="model">purchase.order</field>
            <field name="type">search</field>
            <field name="priority">17</field>
            <field name="arch" type="xml">
                <search string="Search Purchase Order">
                  <group col='10' colspan='4'>
                    <filter icon="terp-document-new" name="draft_rfq" string="Draft" domain="[('rfq_state','=','draft')]" separator="1" help="Requests for Quotation which are in draft state"/>
                    <filter icon="gtk-apply" name="sent" string="Sent" domain="[('rfq_state','=','sent')]" separator="1" />
                    <filter icon="terp-camera_test" name="updated" string="Updated" domain="[('rfq_state','=','updated')]" separator="1" />
                    <filter icon="gtk-yes" name="done" string="Closed" domain="[('rfq_state','=','done')]" separator="1" />
                    <filter icon="gtk-cancel" name="cancelled" string="Cancelled" domain="[('rfq_state','=','cancel')]" separator="1" />
                    <field name="partner_id" select="1" string="Supplier" />
                    <field name="product_id" select="1" />
                    <field name="origin" />
                    <field name="create_uid" select="1"/>
                    <field name="date_order" string="Creation date"/>
                    <newline />
                    <group string="Type" expand="0">
                            <filter icon="terp-check" string="Regular" domain="[('order_type','=','regular')]" />
                            <filter icon="terp-stage" string="Donation before expiry" domain="[('order_type','=','donation_exp')]" />
                            <filter icon="terp-gtk-jump-to-ltr" string="Standard Donation" domain="[('order_type','=','donation_st')]" />
                            <filter icon="terp-partner" string="Loan" domain="[('order_type','=','loan')]" />
                            <filter icon="terp-gtk-jump-to-rtl" string="In-Kind donation" domain="[('order_type','=','in_kind')]" />
                            <filter icon="terp-purchase" string="Purchase List" domain="[('order_type','=','purchase_list')]" />
                            <filter icon="terp-crm" string="Direct PO" domain="[('order_type','=','direct')]" />
                        </group>
                        <newline />
                        <group string="Priority" expand="0">
                            <filter icon="gtk-dialog-warning" string="Emergency" domain="[('priority','=','emergency')]"/>
                            <filter icon="gtk-yes" string="Normal" domain="[('priority','=','normal')]"/>
                            <filter icon="gtk-info" string="Priority" domain="[('priority','=','priority')]"/>
                        </group>
                        <newline />
                        <group string="Category" expand="0">
                            <filter icon="gtk-color-picker" string="Medical" domain="[('categ','=','medical')]"/>
                            <filter icon="terp-stock" string="Logistic" domain="[('categ','=','log')]"/>
                            <filter icon="terp-purchase" string="Service" domain="[('categ','=','service')]"/>
                            <filter icon="gtk-harddisk" string="Other" domain="[('categ','=','other')]"/>
                        </group>
                        <newline />
                </group>
                <newline/>
                <group expand="0" string="Group By..." colspan="4" col="10">
                  <filter string="Order Type" icon="terp-rating-rated" domain="[]" context="{'group_by':'order_type'}"/>
                  <separator orientation="vertical"/>
                  <filter string="Priority" icon="terp-project" domain="[]" context="{'group_by':'priority'}"/>
                  <separator orientation="vertical"/>
                  <filter string="Category" icon="terp-translate" domain="[]" context="{'group_by':'categ'}"/>
                  <separator orientation="vertical"/>
                  <filter string="Supplier" icon="terp-partner" domain="[]" context="{'group_by':'partner_id'}"/>
                  <separator orientation="vertical"/>
                  <filter string="Origin" icon="terp-gtk-jump-to-rtl" domain="[]" context="{'group_by':'origin'}"/>
                  <filter string="State" icon="terp-stock_effects-object-colorize" domain="[]" context="{'group_by':'state'}"/>
                  <separator orientation="vertical"/>
                  <filter string="Creation Date" icon="terp-go-month" domain="[]" context="{'group_by':'date_order'}"/>
                  <filter string="Expected Date" icon="terp-go-month" domain="[]" context="{'group_by':'delivery_requested_date'}"/>
                </group>
              </search>
            </field>
        </record>

        <record id="view_rfq_tree" model="ir.ui.view">
            <field name="name">view.rfq.tree</field>
            <field name="model">purchase.order</field>
            <field name="type">tree</field>
            <field name="priority" eval="300" />
            <field name="arch" type="xml">
                <tree string="Requests for Quotation">
                    <field name="name" />
                    <field name="order_type" />
                    <field name="priority" />
                    <field name="categ" />
                    <field name="date_order" string="Creation date"/>
                    <field name="partner_id" />
                    <field name="delivery_requested_date" />
                    <field name="origin" />
                    <field name="amount_total" />
                    <field name="rfq_state" />
                    <field name="state" invisible="1"/>
                </tree>
            </field>
        </record>

        <record id="purchase_rfq" model="ir.actions.act_window">
            <field name="name">Requests for Quotation</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">purchase.order</field>
            <field name="view_type">form</field>
            <field name="context">{'rfq_ok': True, 'search_default_draft_rfq': 1, 'request_for_quotation': True}</field>
            <field name="domain">[('rfq_ok', '=', True)]</field>
            <field name="view_mode">tree,form,graph,calendar</field>
            <field name="search_view_id" ref="view_rfq_filter"/>
            <field name="help">You can create a request for quotation when you want to buy products to a supplier but the purchase is not confirmed yet. Use also this menu to review requests for quotation created automatically based on your logistic rules (minimum stock, MTO, etc). You can convert the request for quotation into a purchase order once the order is confirmed. If you use the extended interface (from user's preferences), you can select the way to control your supplier invoices: based on the order, based on the receptions or manual encoding.</field>
        </record>

        <menuitem id="purchase.menu_purchase_rfq" 
                  action="purchase.purchase_rfq"
                  sequence="2" 
                  parent="purchase.menu_procurement_management" />


        <record id="purchase_rfq_tree_view_action" model="ir.actions.act_window.view">
            <field name="act_window_id" ref="purchase.purchase_rfq" />
            <field name="sequence">1</field>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="view_rfq_tree" />
        </record>


    </data>
</openerp>