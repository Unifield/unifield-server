<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>

        <record id="shipment_parcel_selection_form_view" model="ir.ui.view">
            <field name="name">shipment.parcel.selection.form.view</field>
            <field name="model">shipment.parcel.selection</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form string="Select Parcel Ids">
                    <separator string="Click on the box to select or unselect the parcel" colspan="4"/>
                    <field name="parcel_number" invisible="1"/>
                    <field name="selected_item_ids" invisible="1"/>
                    <field name="available_items_ids" invisible="1"/>
                    <html colspan="4">
                        <div id="parcels-form">
                            <div id="select-buttons">
                                <span  onclick="select_all()" class="button">Select All</span>
                                <span  onclick="unselect_all()" class="button">Unselect All</span>
                            </div>
                            <div>
                                Search Parcels: <input onkeyup="search_items(this)" />
                            </div>
                            <div>
                                <span id="number_to_select">0</span> parcels to selected, 
                                <span id="number_selected">0</span> selected parcels.
                            </div>
                            <div id="parcel-list">
                                <ul id="parcelids"/>
                            </div>
                        </div>
                        <script language="javascript">
                            function update_number_selected() {
                                var selected = $('#parcelids li.selected').length;
                                var to_select = $('#parcel_number').val();
                                $('#number_selected').html(selected);

                                if ( selected == to_select) {
                                    $("#select_parcels").show()
                                } else {
                                    $("#select_parcels").hide()

                                }
                            }

                            function search_items(inp) {
                                var s = $(inp).val();
                                if (!s) {
                                    $('#parcelids li').show();
                                } else {
                                    $('#parcelids li').each(function () {
                                    $(this).toggle($(this).html().includes(s));
                                });
                                }
                            }

                            function select_all() {
                                $('#parcelids li').addClass('selected');
                                update_number_selected()
                            }

                            function unselect_all() {
                                $('#parcelids li').removeClass('selected');
                                update_number_selected()
                            }

                            $(document).ready(function() {

                                var to_select_number = $('#parcel_number').val()
                                $('#number_to_select').html(to_select_number);

                                var available_items_ids = $('#available_items_ids').val().split(',');

                                var selected_item_ids = Array()
                                var selected_item = $('#selected_item_ids').val()
                                if (selected_item) {
                                    selected_item_ids=selected_item.split(',');
                                } else if (to_select_number >= available_items_ids.length / 2) {
                                    selected_item_ids = available_items_ids;
                                }

                                available_items_ids.forEach(function (f){
                                    var myclass='';
                                    if (selected_item_ids.includes(f)) {
                                        myclass='selected';
                                    }
                                    $("&lt;li&gt;"+f+"&lt;/li&gt;").addClass(myclass).click(function(){$(this).toggleClass('selected'); update_number_selected();}).appendTo('#parcelids');
                                })

                                update_number_selected();

                                var original_onclick = $('#select_parcels').attr('onclick');
                                $('#select_parcels').removeAttr('onclick');
                                $("#select_parcels").click(function() {
                                    list_selected = Array()
                                    $('#parcelids li.selected').each(function(){
                                        list_selected.push($(this).html());
                                    });
                                    $('#selected_item_ids').val(list_selected.join(','));

                                    original_onclick();
                                });
                            });

                        </script>
                    </html>
                    <button special="cancel" string="_Cancel" icon="gtk-cancel"/>
                    <button name="select_parcels" string="Ok" type="object" icon="gtk-ok"/>
            </form>

            </field>
        </record>

    </data>
</openerp>
