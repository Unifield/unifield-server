<?xml version="1.0" encoding="UTF-8"?>
<openerp>
  <data>
    <record model="ir.ui.view" id="syncback_config_tree_view">
      <field name="name">sync.backup.config.tree</field>
      <field name="model">backup.config</field>
      <field name="type">tree</field>
      <field name="arch" type="xml">
        <tree string="Backup Tree" hide_new_button="1" hide_delete_button="1" >
          <field name="name"/>
          <field name="beforemanualsync"/>
          <field name="beforeautomaticsync"/>
          <field name="aftermanualsync"/>
          <field name="afterautomaticsync"/>
          <field name="beforepatching"/>
          <field name="scheduledbackup"/>
        </tree>
      </field>
    </record>

    <record model="ir.ui.view" id="syncback_config_form_view">
      <field name="name">sync.backup.config.form</field>
      <field name="model">backup.config</field>
      <field name="type">form</field>
      <field name="arch" type="xml">
        <form string="Backup configuration" hide_new_button="1" hide_delete_button="1" hide_duplicate_button="1">
        <html colspan="4">
<script language="javascript">
$(document).ready(function() {
orig_value =  $('#configpsql').html()

    update_help = function() {
    var wal_dir_value = $('#wal_directory').val().replaceAll('/', '\\').replaceAll('\\', '\\\\').replace(/\\+$/, '');
    var configpsql = orig_value.replaceAll('D:\\\\WAL', wal_dir_value);
    $('#configpsql').html(configpsql );
};
$('#help_wal_checkbox_').click(update_help);
$('#wal_directory').change(update_help);
});
</script>
</html>
            <group col="6" colspan="6">
            <field name="name"/>
            </group>
            <group col="4">
            <field name="beforemanualsync"/>
            <field name="beforeautomaticsync"/>
            <field name="aftermanualsync"/>
            <field name="afterautomaticsync"/>
            <field name="beforepatching"/>
            <field name="scheduledbackup"/>
            </group>
            <button type="object" string="Backup" name="button_exp_dump" icon="db_dump.png" />
            <group colspan="6">
                <html>
                    <br /><br />
                </html>
            </group>
            <group col="6" colspan="6">
            <separator colspan="6" string="Backup" />
            <field name="backup_date" />
            <field name="backup_size" widget="human_size"/>
            <field name="backup_path" colspan="6" />
            <group colspan="6">
                <html>
                    <br /><br />
                </html>
            </group>
            <separator colspan="6" string="Type of Backup" />
            <field name="backup_type" />

            <group colspan="6" col="6" attrs="{'invisible': [('backup_type', '!=', 'sharepoint')]}">
            <field name="cloud_url" widget="url" colspan="6"/>
            <newline />
            <field name="cloud_date" />
            <field name="cloud_backup" />
            <field name="cloud_size" widget="human_size" />
            <button type="object" string="Test Cloud"  name="test_cloud" icon="monitor.png" colspan="3"/>
            <button type="object" string="Send Last Backup to remote" name="send_to_cloud" icon="cloud.png" colspan="3"/>
            <group colspan="6">
                <html>
                    <br /><br />
                </html>
            </group>
            <field name="cloud_error" colspan="6" widget="full_text"/>
            </group>

            <group colspan="6" attrs="{'invisible': [('backup_type', '!=', 'cont_back')]}">
            <field name="help_wal" readonly="0"/>
            <group colspan="6" attrs="{'invisible': [('help_wal', '=', False)]}">
            <html>

                <h4><translate>Steps to activate Continuous backup</translate></h4>
                <ul>
                    <li><translate>Unzip your keys in in C:\Program Files (x86)\msf\</translate></li>
                    <li><translate>Edit pg_hba.conf and add:</translate>
<pre>
host    replication     openpg        127.0.0.1/32            md5
host    replication     openpg        ::1/128                 md5
</pre>
</li>

                    <li><translate>Edit postgresql.conf and set:</translate>
<pre id="configpsql">
wal_level = replica
wal_compression = on
archive_mode = on
archive_command = '"C:\\Program Files (x86)\\msf\\Unifield\\Server\\rsync\\7za.exe" -bd -bso0 -w"D:\\WAL" a "D:\\WAL\\%%f.7z" "%%p"'
max_wal_senders = 3
archive_timeout = 43200
</pre>
<translate>Replace the 3 occurences of "D:\\WAL\\" with the path to the local WAL Archive directory.</translate>
</li>

                    <li><translate>Stop OpenERP server</translate></li>
                    <li><translate>Restart PostgreSQL</translate></li>
                    <li><translate>Start OpenERP server</translate></li>
                 </ul>
            <br />
            <br />
            <br />
            </html>
            </group>
            <field name="wal_directory" attrs="{'required': [('backup_type', '=', 'cont_back')]}" colspan="3"/>
            <field name="ssh_config_dir"  attrs="{'required': [('backup_type', '=', 'cont_back')]}" colspan="3"/>
            <newline />
            <field name="remote_user" />
            <field name="remote_host" />
            <button type="object" string="Generate Base Backup" name="button_basebackup" icon="db_dump.png" colspan="2"/>
            <button type="object" string="Send WAL/Base backup to remote" name="button_rsync" icon="cloud.png" colspan="2"/>

            <field name="basebackup_date" />
            <field name="rsync_date" />
            <field name="basebackup_error" colspan="6" attrs="{'invisible': [('basebackup_error', '=', False)]}"/>
            <field name="rsync_error" colspan="6" attrs="{'invisible': [('rsync_error', '=', False)]}"/>
            </group>
        </group>
        </form>
      </field>
    </record>

        <record id="ir_actions_server_openbackupconfig" model="ir.actions.server">
            <field name="code">
res = obj.pool.get('ir.model.data').get_object_reference(cr, uid, 'sync_client', 'backup_config_default')
action = {
'res_model' : 'backup.config',
'view_type' : 'form',
'view_mode' : 'form,tree',
'type': 'ir.actions.act_window',
'res_id' : res[1],
}</field>
            <field eval="5" name="sequence"/>
            <field name="state">code</field>
            <field name="type">ir.actions.server</field>
            <field name="model_id" ref="model_backup_config"/>
            <field name="condition">True</field>
            <field name="name">Open Backup config</field>
        </record>


        <record id="ir_ui_menu_backupconfig" model="ir.ui.menu">
            <field name="name">Backup config</field>
            <field name="parent_id" ref="syncback_menu"/>
            <field name="sequence">25</field>
        </record>

        <record id="ir_values_menuitem_backupconfig" model="ir.values">
            <field name="name">Menuitem backup config</field>
            <field name="key2">tree_but_open</field>
            <field eval="1" name="object"/>
            <field name="value" eval="'ir.actions.server,%s' % ref('sync_client.ir_actions_server_openbackupconfig')" />
            <field name="key">action</field>
            <field name="model">ir.ui.menu</field>
            <field eval="ref('ir_ui_menu_backupconfig')" name="res_id"/>
        </record>



        <record id="ir_actions_server_opensyncbackup" model="ir.actions.server">
            <field name="code">
res = obj.pool.get('ir.model.data').get_object_reference(cr, uid, 'sync_client', 'ir_cron_automaticsyncbackup')
action = {
'res_model' : 'ir.cron',
'view_type' : 'form',
'view_mode' : 'form',
'type': 'ir.actions.act_window',
'res_id' : res[1],
}</field>
            <field eval="5" name="sequence"/>
            <field name="state">code</field>
            <field name="type">ir.actions.server</field>
            <field name="model_id" ref="base.model_ir_cron"/>
            <field name="condition">True</field>
            <field name="name">Open Backup cron</field>
        </record>


        <record id="ir_ui_menu_cron_synchrobackup" model="ir.ui.menu">
            <field name="name">Automatic</field>
            <field name="parent_id" ref="syncback_menu"/>
            <field name="sequence">30</field>
        </record>

        <record id="ir_values_menuitem_cronbackup" model="ir.values">
            <field name="name">Menuitem IR CRON</field>
            <field name="key2">tree_but_open</field>
            <field eval="1" name="object"/>
            <field name="value" eval="'ir.actions.server,%s' % ref('ir_actions_server_opensyncbackup')" />
            <field name="key">action</field>
            <field name="model">ir.ui.menu</field>
            <field eval="ref('ir_ui_menu_cron_synchrobackup')" name="res_id"/>
        </record>

    <record id="backup_download_tree" model="ir.ui.view">
      <field name="name">backup.download.tree</field>
      <field name="model">backup.download</field>
      <field name="type">tree</field>
      <field name="arch" type="xml">
        <tree string="Dump files" hide_new_button="1" hide_delete_button="1" hide_edit_button="1" colors="red: failed">
          <field name="name"/>
          <field name="mtime"/>
          <field name="failed" invisible="1" />
          <button type="object" name="get_content" string="Get Content" icon="gtk-go-forward" attrs="{'invisible': [('failed', '=', True)]}"/>
        </tree>
      </field>
    </record>

    <record id="backup_download_form" model="ir.ui.view">
      <field name="name">backup.download.form</field>
      <field name="model">backup.download</field>
      <field name="type">form</field>
      <field name="arch" type="xml">
        <form string="Select a file to download" editable="top" hide_new_button="1" hide_delete_button="1" hide_duplicate_button="1">
          <group colspan="4" col="6">
              <field name="name"/>
              <field name="mtime"/>
              <field name="failed" invisible="1" />
              <button type="object" name="get_content" string="Get Content" icon="gtk-go-forward" attrs="{'invisible': [('failed', '=', True)]}"/>
         </group>
        </form>
      </field>
    </record>

    <record id="backup_download_search" model="ir.ui.view">
      <field name="name">backup.download.search</field>
      <field name="model">backup.download</field>
      <field name="type">search</field>
      <field name="arch" type="xml">
        <search>
          <filter icon="terp-check" name="Success" string="Success" domain="[('failed', '=', False)]"/>
          <filter icon="gtk-cancel" name="Failure" string="Failure" domain="[('failed', '=', True)]"/>
          <separator />
          <field name="name"/>
          <field name="mtime"/>
        </search>
      </field>
    </record>

    <record id="backup_download_open_wiz" model="ir.actions.server">
        <field name="name">Get dump</field>
        <field name="model_id" ref="model_backup_download"/>
        <field name="state">code</field>
        <field name="code">action = obj.open_wiz()</field>
    </record>

    <record id="backup_download_menu" model="ir.ui.menu">
        <field name="name">Get backup files</field>
        <field name="sequence" eval="50"/>
        <field name="parent_id" ref="syncback_menu"/>
        <field name="action" ref="backup_download_open_wiz"/>
    </record>

    <record id="upload_backup_form" model="ir.ui.view">
      <field name="name">msf.instance.cloud.progress.form</field>
      <field name="model">msf.instance.cloud.progress</field>
      <field name="type">form</field>
      <field name="arch" type="xml">
        <form string="Upload in progress">
              <field name="start" />
              <newline />
              <field name="name" widget="progressbar"/>
              <newline />
              <field name="state" invisible="1"/>
              <newline />
              <field name="message" nolabel="1" colspan="4" widget="full_text" />
              <button type="special" special="cancel" string="Close" colspan="2" icon="gtk-cancel"/>
            <html>
              <script language="javascript">
                $(document).ready(function() {
                    if ($('#state').val() != 'Done') {
                        setTimeout(function(){
                         location = ''
                        },600)
                    }
                });
              </script>
            </html>
        </form>
      </field>
    </record>
    </data>
</openerp>
