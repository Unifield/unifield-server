<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>
    <!-- Supplier Invoice Form -->
        <record model="ir.ui.view" id="wizard_supplier_invoice_form">
            <field name="name">wizard.supplier.invoice.form</field>
            <field name="model">wizard.account.invoice</field>
            <field name="type">form</field>
            <field name="inherit_id" eval="False" />
            <field name="priority">200</field>
            <field name="arch" type="xml">
                <form string="Supplier Invoice">
                    <group colspan="4" col="6">
                        <field name="journal_id" domain="[('is_current_instance','=',True),('type','=','purchase')]" on_change="onchange_journal_id(journal_id)" widget="selection"/>
                        <field name="number" readonly="1" />
                        <field name="type" invisible="1"/>
                        <field name="currency_id" readonly="1" />
                        <newline/>
                        <field name="partner_id" on_change="onchange_partner_id(type,partner_id,date_invoice,payment_term, partner_bank_id,company_id)" context="{'default_customer': 0, 'search_default_supplier': 1, 'default_supplier': 1}" required="1"/>
                        <field domain="[('partner_id','=',partner_id)]" name="address_invoice_id" required="1"/>
                        <newline/>
                        <field name="document_date" required="1"/>
                        <field name="date_invoice" required="1"/>
                        <field name="register_posting_date" />
                        <field name="state" invisible="1"/>
                        <newline/>
                        <label string="" colspan="4"/>
                        <field name="amount_total"/>
                    </group>
                    <button name="button_analytic_distribution" string="Analytical Distribution" type="object" icon="terp-check" context="context" colspan="2" attrs="{'invisible': [('analytic_distribution_id', '=', False)]}"/>
                    <button name="button_analytic_distribution" string="Analytical Distribution" type="object" icon="terp-emblem-important" context="context" colspan="2" attrs="{'invisible': [('analytic_distribution_id', '!=', False)]}"/>
                    <field name="analytic_distribution_id" invisible="1"/>
                    <group colspan="2"/>
                    <notebook colspan="4">
                        <page string="Invoice">
                            <field name="account_id" domain="[('company_id', '=', company_id), ('type', '=', 'payable')]" required="1"/>
                            <field name="check_total" readonly="1" invisible="1"/>
                            <field colspan="4" default_get="{'check_total': check_total, 'address_invoice_id': 
                                address_invoice_id, 'partner_id': partner_id, 'price_type': 'price_type' in dir() and price_type or False}" 
                                name="invoice_line" nolabel="1">
                                <tree editable="bottom" string="Invoice lines" colors="blue:analytic_distribution_state in ('valid');red:analytic_distribution_state in ('invalid');black:analytic_distribution_state in ('none')">
                                    <field name="product_id" on_change="product_id_change(product_id, uos_id, quantity, name, parent.type, 
                                        parent.partner_id, parent.fiscal_position, price_unit, parent.address_invoice_id, parent.currency_id, 
                                        {'company_id': parent.company_id})"/>
                                    <field domain="[('company_id', '=', parent.company_id), ('journal_id', '=', parent.journal_id), 
                                        ('type', '&lt;&gt;', 'view')]" name="account_id" on_change="onchange_account_id(parent.fiscal_position,account_id)"/>
                                    <button name="button_analytic_distribution" string="Analytical Distribution" type="object" icon="terp-stock_symbol-selection" 
                                        context="{'d_journal_id': parent.journal_id , 'd_partner_id': parent.partner_id, 'd_address_invoice_id':parent.address_invoice_id,'d_date_invoice': parent.date_invoice, 'd_register_posting_date': parent.register_posting_date, 'd_document_date': parent.document_date, 'd_account_id': parent.account_id, 'd_partner_bank_id': parent.partner_bank_id, 'd_payment_term': parent.payment_term, 'd_name': parent.name, 'd_origine': parent.origin, 'd_address_contact_id': parent.address_contact_id, 'd_user_id': parent.user_id, 'd_comment': parent.comment}"
                                        />
                                    <field name="analytic_distribution_state_recap" attrs="{'invisible': [('is_allocatable', '=', False)]}"/>
                                    <field name="analytic_distribution_state" invisible="1"/>
                                    <field name="have_analytic_distribution_from_header" invisible="1"/>
                                    <field name="is_allocatable" invisible="1"/>
                                    <field name="quantity"/>
                                    <field name="price_unit"/>
                                     <!-- Removed if subtotal is set -->
                                    <field name="price_subtotal"/>
                                    <field name="name"/>
                                    <field invisible="True" name="uos_id"/>
                                </tree>
                            </field>
                            <group col="4" colspan="4">
                                <button string="Compute Total" name="compute_wizard" type="object" icon='gtk-execute' colspan="4"/>
                                <group col="6" colspan="4">
                                    <button name="invoice_reset_wizard" string="Reset Invoice" icon="gtk-cancel" type="object" attrs="{'invisible':['|', ('partner_id','=',False), ('date_invoice','=',False)]}"/>
                                    <button name="invoice_create_wizard" string="Validate" icon="terp-camera_test" type="object"/>
                                </group>
                            </group>
                        </page>
                        <page string="Other Info">
                            <field domain="[('partner_id', '=', partner_id)]" name="partner_bank_id" on_change="onchange_partner_bank(partner_bank_id)"/>
                            <field name="company_id" on_change="onchange_company_id(company_id,partner_id,type,invoice_line,currency_id)" 
                                widget="selection" groups="base.group_multi_company"/>
                            <newline/>
                            <field name="payment_term" widget="selection"/>
                            <field name="name"/>
                            <newline/>
                            <field name="origin" />
                            <field domain="[('partner_id','=',partner_id)]" name="address_contact_id" />
                            <field name="user_id"/>
                            <separator colspan="4" string="Additional Information"/>
                            <field colspan="4" name="comment" nolabel="1"/>
                        </page>
                    </notebook>
                </form>
            </field>
        </record>

    <!-- Add a filter on Supplier Invoices in order to hide Direct Invoices (those which have register_line_ids) -->
        <record id="account.action_invoice_tree2" model="ir.actions.act_window">
            <field name="name">Supplier Invoices</field>
            <field name="res_model">account.invoice</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form,calendar,graph</field>
            <field eval="False" name="view_id"/>
            <field name="domain">[('type','=','in_invoice'), ('register_line_ids', '=', False)]</field>
            <field name="context">{'type':'in_invoice', 'journal_type': 'purchase'}</field>
            <field name="search_view_id" ref="account.view_account_invoice_filter"/>
            <field name="help">With Supplier Invoices you can enter and manage invoices issued by your suppliers. 
                OpenERP can also generate draft invoices automatically from purchase orders or receipts. This way, you can control the invoice 
                from your supplier according to what you purchased or received.</field>
        </record>

    <!--
        Supplier Direct Invoice Pop-up for Registers 
        All fields are readonly (except dates) since UF-1527 because of workflow change on it.
    -->
        <record model="ir.ui.view" id="direct_supplier_invoice_form">
            <field name="name">direct_supplier.invoice.form</field>
            <field name="model">account.invoice</field>
            <field name="type">form</field>
            <field name="inherit_id" eval="False" />
            <field name="priority">250</field>
            <field name="arch" type="xml">
                <form string="Supplier Invoice" hide_duplicate_button="1" hide_new_button="1">
                    <group colspan="4" col="8">
                        <field name="is_direct_invoice" invisible="1" readonly="1"/>
                        <field name="journal_id" on_change="onchange_journal_id(journal_id)" widget="selection" attrs="{'readonly': [('is_direct_invoice', '=', True)]}" />
                        <field name="number" readonly="1"/>
                        <field name="type" invisible="1"/>
                        <field name="currency_id" invisible="1" />
                        <field name="fake_currency_id" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>
                        <newline/>
                        <field name="partner_id" on_change="onchange_partner_id(type,partner_id,date_invoice,payment_term, partner_bank_id,company_id)" context="{'default_customer': 0, 'search_default_supplier': 1, 'default_supplier': 1}" required="1" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>

                        <field domain="[('partner_id','=',partner_id)]" name="address_invoice_id" required="1" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>
                        <newline/>
                        <field name="document_date" required="1" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>
                        <field name="date_invoice" required="1" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>
                        <field name="register_posting_date" required="1" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>
                        <newline/>
                        <label string="" colspan="4"/>
                        <field name="amount_total"/>
                    </group>
                    <button name="button_analytic_distribution_from_direct_inv" string="Analytical Distribution" type="object" icon="terp-check" context="context" colspan="2" attrs="{'invisible': [('analytic_distribution_id', '=', False)]}"/>
                    <button name="button_analytic_distribution_from_direct_inv" string="Analytical Distribution" type="object" icon="terp-emblem-important" context="context" colspan="2" attrs="{'invisible': [('analytic_distribution_id', '!=', False)]}"/>
                    <field name="analytic_distribution_id" invisible="1"/>
                    <group colspan="2"/>
                    <notebook colspan="4">
                        <page string="Invoice">
                            <field name="account_id" domain="[('company_id', '=', company_id), ('type', '=', 'payable')]" required="1" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>
                            <field name="check_total" readonly="1" invisible="1"/>
                            <field colspan="4" default_get="{'check_total': check_total, 'address_invoice_id': 
                                address_invoice_id, 'partner_id': partner_id, 'price_type': 'price_type' in dir() and price_type or False}" 
                                name="invoice_line" nolabel="1" attrs="{'readonly': [('state', 'not in', ['draft', 'open']), ('is_direct_invoice', '=', True)]}">
                                <tree editable="bottom" string="Invoice lines" colors="blue:analytic_distribution_state in ('valid');red:analytic_distribution_state in ('invalid');black:analytic_distribution_state in ('none')">
                                    <field name="product_id" on_change="product_id_change(product_id, uos_id, quantity, name, parent.type, 
                                        parent.partner_id, parent.fiscal_position, price_unit, parent.address_invoice_id, parent.currency_id, 
                                        {'company_id': parent.company_id})"/>
                                    <field domain="[('company_id', '=', parent.company_id), ('journal_id', '=', parent.journal_id), 
                                        ('type', '&lt;&gt;', 'view')]" name="account_id" on_change="onchange_account_id(parent.fiscal_position,account_id)"/>
                                    <button name="button_analytic_distribution_from_direct_inv_line" string="Analytical Distribution" type="object" icon="terp-stock_symbol-selection" 
                                        context="{'d_journal_id': parent.journal_id , 'd_partner_id': parent.partner_id, 'd_address_invoice_id':parent.address_invoice_id,'d_date_invoice': parent.date_invoice, 'd_register_posting_date': parent.register_posting_date, 'd_document_date': parent.document_date, 'd_account_id': parent.account_id, 'd_partner_bank_id': parent.partner_bank_id, 'd_payment_term': parent.payment_term, 'd_name': parent.name, 'd_origine': parent.origin, 'd_address_contact_id': parent.address_contact_id, 'd_user_id': parent.user_id, 'd_comment': parent.comment}"
                                        />
                                    <field name="analytic_distribution_state_recap" attrs="{'invisible': [('is_allocatable', '=', False)]}"/>
                                    <field name="analytic_distribution_state" invisible="1"/>
                                    <field name="have_analytic_distribution_from_header" invisible="1"/>
                                    <field name="is_allocatable" invisible="1"/>
                                    <field name="quantity"/>
                                    <field name="price_unit"/>
                                     <!-- Removed if subtotal is set -->
                                    <field name="price_subtotal"/>
                                    <field name="name"/>
                                    <field invisible="True" name="uos_id"/>
                                </tree>
                            </field>
                            <group col="4" colspan="4">
                                <button string="Compute Total" name="button_dummy_compute_total" type="object" icon='gtk-execute' colspan="4" states="draft,open"/>
                                <button name="button_close_direct_invoice" string="Validate" icon="terp-camera_test" type="object" colspan="4" states="draft,open"/>
                            </group>
                        </page>
                        <page string="Other Info">
                            <field domain="[('partner_id', '=', partner_id)]" name="partner_bank_id" on_change="onchange_partner_bank(partner_bank_id)" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>
                            <field name="company_id" on_change="onchange_company_id(company_id,partner_id,type,invoice_line,currency_id)" 
                                widget="selection" groups="base.group_multi_company" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>
                            <newline/>
                            <field name="payment_term" widget="selection" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>
                            <field name="name" attrs="{'readonly': [('is_direct_invoice', '=', True), ('state', 'not in', ['draft', 'open'])]}"/>
                            <newline/>
                            <field name="origin" attrs="{'readonly': [('is_direct_invoice', '=', True), ('state', 'not in', ['draft', 'open'])]}"/>
                            <field domain="[('partner_id','=',partner_id)]" name="address_contact_id" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>
                            <field name="user_id" attrs="{'readonly': [('is_direct_invoice', '=', True)]}"/>
                            <separator colspan="4" string="Additional Information"/>
                            <field colspan="4" name="comment" nolabel="1"/>
                        </page>
                    </notebook>
                    <field name="state" readonly="1" colspan="4"/>
                </form>
            </field>
        </record>

    <!-- Give Direct Invoices -->
        <record id="action_direct_invoice" model="ir.actions.act_window">
            <field name="name">Supplier Direct Invoices</field>
            <field name="res_model">account.invoice</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form,calendar,graph</field>
            <field name="view_id" ref="direct_supplier_invoice_form"/>
            <field name="domain">[('type','=','in_invoice'), ('register_line_ids', '!=', False)]</field>
            <field name="context">{'type':'in_invoice', 'journal_type': 'purchase'}</field>
            <field name="search_view_id" ref="account.view_account_invoice_filter"/>
            <field name="help">With Supplier Direct Invoices you can enter and manage direct invoices issued by your user into Registers.</field>
        </record>

        <record id="direct_invoice_tree" model="ir.ui.view">
            <field name="name">account.invoice.tree.direct</field>
            <field name="model">account.invoice</field>
            <field name="type">tree</field>
            <field name="priority">250</field>
            <field name="arch" type="xml">
                <tree colors="blue:state in ('draft');black:state in ('proforma','proforma2','open');gray:state in ('cancel')" string="Invoice" hide_new_button="1" >
                    <field name="document_date"/>
                    <field name="date_invoice"/>
                    <field name="number"/>
                    <field name="partner_id" />
                    <field name="name"/>
                    <field name="journal_id" invisible="1"/>
                    <field name="period_id" invisible="1" />
                    <field name="company_id" groups="base.group_multi_company" widget="selection"/>
                    <field name="user_id" invisible="1"/>
                    <field name="date_due"/>
                    <field name="origin"/>
                    <field name="currency_id"/>
                    <field name="residual" sum="Residual Amount"/>
                    <field name="amount_untaxed" sum="Untaxed Amount" invisible="1"/>
                    <field name="amount_total" sum="Total Amount"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

        <record model="ir.actions.act_window.view" id="act_direct_supplier_invoice">
            <field name="sequence" eval="5"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="direct_invoice_tree"/>
            <field name="act_window_id" ref="action_direct_invoice"/>
        </record>

    <!-- Supplier Direct Invoices Menu -->
        <menuitem action="action_direct_invoice" id="menu_action_direct_invoice" parent="account.menu_finance_payables"/>


    <!-- Validate button is set as function -->
        <record id="invoice_tree_2" model="ir.ui.view">
            <field name="name">account.invoice.tree.2</field>
            <field name="model">account.invoice</field>
            <field name="type">tree</field>
            <field name="inherit_id" ref="account.invoice_tree"/>
            <field name="priority">18</field>
            <field name="arch" type="xml">
                <xpath expr="/tree/button[@name='invoice_open']" position="replace">
                    <button name="invoice_open" states="draft,proforma2" type="object" string="Approve" icon="terp-camera_test"/>
                </xpath>
            </field>
        </record>
            
        <record id="invoice_form_2" model="ir.ui.view">
            <field name="name">account.invoice.form.2</field>
            <field name="model">account.invoice</field>
            <field name="type">form</field>
            <field name="inherit_id" ref="account.invoice_form"/>
            <field name="priority">50</field>
            <field name="arch" type="xml">
                <data>
                    <field name="journal_id" position="replace">
                        <field name="journal_id" domain="[('is_current_instance','=',True)]" on_change="onchange_journal_id(journal_id)"/>
                    </field>
                    <button name="action_cancel_draft" position="replace"/>
                    <button name='invoice_open' position="replace">
                        <button name="invoice_open" states="draft,proforma2" type="object" string="Validate" icon="gtk-go-forward"/>
                    </button>
                </data>
            </field>
        </record>
            
        <record id="invoice_supplier_form_2" model="ir.ui.view">
            <field name="name">account.invoice.supplier.form.2</field>
            <field name="model">account.invoice</field>
            <field name="type">form</field>
            <field name="inherit_id" ref="account.invoice_supplier_form"/>
            <field name="priority">55</field>
            <field name="arch" type="xml">
                <data>
                    <field name="journal_id" position="replace">
                        <field name="journal_id" domain="[('is_current_instance','=',True)]" on_change="onchange_journal_id(journal_id)"/>
                    </field>
                    <button name="action_cancel_draft" position="replace"/>
                    <button name='invoice_open' position="replace">
                        <button name="invoice_open" states="draft,proforma2" type="object" string="Validate" icon="gtk-go-forward"/>
                        <field name="is_direct_invoice" invisible="1"/>
                    </button>
                </data>
            </field>
        </record>

    <!-- Delete "Pay Invoice" button by deleting view that add it previously -->
        <delete model="ir.ui.view" id="account_voucher.view_invoice_supplier"/>
        <delete model="ir.ui.view" id="account_voucher.view_invoice_customer"/>

    </data>
</openerp>
