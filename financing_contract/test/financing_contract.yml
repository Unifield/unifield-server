-
  In order to test the financing contract,
  we need a lot.
  I create, in order, a account type, ...
-
  !record {model: account.account.type, id: account_account_type_expense0}:
    close_method: none
    code: expense
    name: Expense
    sign: 1
-
  ...an account, ...
-
  !record {model: account.account, id: test_expense}:
    name: "Test Expense"
    code: "TEST"
    user_type: account_account_type_expense0
    type: payable 
-
 ...a cost center...
-
  !record {model: account.analytic.account, id: analytic_account_OC1}:
    name: "OC1"
    code: "OC1"
    category: OC
-
 ...a funding pool...
-
  !record {model: account.analytic.account, id: analytic_account_FP1}:
    name: "FP1"
    code: "FP1"
    category: FUNDING
    cost_center_ids:
      - analytic_account_OC1
    account_ids:
      - test_expense
-
  I set the company currency's rate to 1 for the move
-
  !record {model: res.currency.rate, id: currency_rate_test_3}:
    name: !eval "'%s-01-01' %(datetime.now().year+1)"
    rate: 1.00
    currency_id: base.CHF
-
  I set another currency's rate to 100 for the move
-
  !record {model: res.currency.rate, id: currency_rate_test_4}:
    name: !eval "'%s-01-01' %(datetime.now().year+1)"
    rate: 100.00
    currency_id: base.EUR
-
  ...an analytical journal, ...
-
  !record {model: account.analytic.journal, id: analytic_journal_1}:
    code: CANJ
    name: Cash Analytic Journal
    type: general
-
  ...a journal, ...
-
  !record {model: account.journal, id: account_journal_1}:
    name: Cash Journal
    code: CTST
    currency: base.EUR
    type: cash
    analytic_journal_id: analytic_journal_1
-
  ...a fiscal year, ...
-
  !record {model: account.fiscalyear, id: account_fiscalyear_fiscalyear0}:
    code: !eval "'FY%s'% (datetime.now().year+1)"
    company_id: base.main_company
    date_start: !eval "'%s-01-01' %(datetime.now().year+1)"
    date_stop: !eval "'%s-12-31' %(datetime.now().year+1)"
    name: !eval "'Fiscal Year %s' %(datetime.now().year+1)"
-
  ... and a period.
-
  !record {model: account.period, id: account_period_mar0}:
    company_id: base.main_company
    date_start: !eval "'%s-03-01' %(datetime.now().year+1)"
    date_stop: !eval "'%s-03-31' %(datetime.now().year+1)"
    fiscalyear_id: account_fiscalyear_fiscalyear0
    name: !eval "'Mar %s' %(datetime.now().year+1)"
    special: 1
    state: draft
-
  ... and a distribution.
-
  !record {model: analytic.distribution, id: distribution_test}:
    cost_center_lines: 
    - analytic_id: analytic_account_OC1
      percentage: 100
      currency_id: base.CHF
      date: !eval "'%s-03-12' %(datetime.now().year+1)"
    funding_pool_lines:
    - analytic_id: analytic_distribution.analytic_account_msf_private_funds
      cost_center_id: analytic_account_OC1
      percentage: 50
      currency_id: base.CHF
      date: !eval "'%s-03-12' %(datetime.now().year+1)"
    - analytic_id: analytic_account_FP1
      cost_center_id: analytic_account_OC1
      percentage: 50
      currency_id: base.CHF
      date: !eval "'%s-03-12' %(datetime.now().year+1)"
-
  I create an account move line with all of this.
-
  !record {model: account.move.line, id: move_line_test}:
    name: testline
    journal_id: account_journal_1
    period_id: account_period_mar0
    account_id: test_expense
    currency_id: base.CHF
    date: !eval "'%s-03-12' %(datetime.now().year+1)"
    debit_currency: 4242.0
    analytic_distribution_id: distribution_test
      
-
  Analytic lines are created from it
-
  !python {model: account.move.line}: |
    self.create_analytic_lines(cr, uid, [ref("move_line_test")], context={})

-
  Create a donor (almost empty)
-
  !record {model: financing.contract.donor, id: donor1}:
    name: "Donor"
    code: "TEST"
-
  Create a contract
-
  !record {model: financing.contract.contract, id: contract1}:
    name: "Contract"
    code: "TEST"
    donor_id: donor1
    grant_amount: 100000.0
    eligibility_from_date: !eval "'%s-01-01' %(datetime.now().year+1)"
    eligibility_to_date: !eval "'%s-12-31' %(datetime.now().year+1)"
    reporting_currency: base.CHF
    funding_pool_ids:
      - analytic_account_FP1
    actual_line_ids:
      - name: "A"
        code: "A"
        account_ids:
          - test_expense
-
  Assert that total retrieved for funded is 2121 CHF
-
  !python {model: financing.contract.contract}: |
    context = {"reporting_currency": ref("base.CHF"),
               "reporting_type": "all",
               "currency_table_id": None}
    contract = self.browse(cr, uid, ref("contract1"), context=context)
    assert contract.report_line.allocated_real == 2121.0, ("Allocation is not what is expected! %s!=2121.0"%contract.report_line.allocated_real)
-
  Assert that total retrieved for funded is 212100 EUR
-
  !python {model: financing.contract.contract}: |
    context = {"reporting_currency": ref("base.EUR"),
               "reporting_type": "all",
               "currency_table_id": None}
    contract = self.browse(cr, uid, ref("contract1"), context=context)
    assert contract.report_line.allocated_real == 212100.0, ("Allocation is not what is expected! %s!=212100.0"%contract.report_line.allocated_real)
-
  Create a currency table
-
  !record {model: res.currency.table, id: test_table}:
    name: "Test"
    code: "TEST"
-
  Change test currency's rate for this table
-
  !python {model: res.currency.rate}: |
    import datetime
    rate_ids = self.pool.get("res.currency").search(cr, uid, [("reference_currency_id", "=", ref("base.EUR")),
                                                              ("currency_table_id", "=", ref("test_table"))])
                                                              
    assert len(rate_ids) == 1, "Something wrong with the currency table creation"
    self.create(cr, uid, {"name": "%s-03-01" %(datetime.datetime.now().year+1),
                          "rate": 10.0,
                          "currency_id": rate_ids[0]})
-
  Assert that total retrieved for funded with currency table is 21210 EUR
-
  !python {model: financing.contract.contract}: |
    context = {"reporting_currency": ref("base.EUR"),
               "reporting_type": "all",
               "currency_table_id": ref("test_table")}
    contract = self.browse(cr, uid, ref("contract1"), context=context)
    assert contract.report_line.allocated_real == 21210.0, ("Allocation is not what is expected! %s!=21210.0"%contract.report_line.allocated_real)
    
