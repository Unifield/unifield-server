<?xml version="1.0" encoding="utf-8"?>
<openerp>
	<data>

		<!-- sale.order.line embedded in sale.order -->
		<record id="view_order_form" model="ir.ui.view">
			<field name="name">sale.order.form</field>
			<field name="model">sale.order</field>
			<field name="type">form</field>
			<field name="priority">500</field>
			<field name="inherit_id" ref="sale.view_order_form" />
			<field name="arch" type="xml">
				<data>

					<field name="price_unit" position="after">
						<field name="supplier" invisible="True" />
						<field name="po_cft" invisible="True" />
					</field>
					
					<xpath expr="/form/notebook/page//button[@name='order_confirm']" position="replace">
						<button name="order_confirm" states="validated" string="Confirm Order" icon="gtk-apply" invisible="True" />
                    	<button name="order_confirm_method" type="object" states="validated" string="Confirm Order" icon="gtk-apply"/>
                    </xpath>

				</data>
			</field>
		</record>

		<record id="sourcing_line_normal_form_view" model="ir.ui.view">
			<field name="name">sourcing.line.form</field>
			<field name="model">sourcing.line</field>
			<field name="type">form</field>
			<field name="arch" type="xml">
				<form string="Sourcing Line">
					<field name="name" />
					<field name="sale_order_id" />
					<field name="sale_order_line_id" />
					<field name="reference" />
					<field name="state" />
				</form>
			</field>
		</record>

		<record id="sourcing_line_normal_tree_view" model="ir.ui.view">
			<field name="name">sourcing.line.tree</field>
			<field name="model">sourcing.line</field>
			<field name="type">tree</field>
			<field name="arch" type="xml">
				<tree string="Sourcing Lines" editable="top" hide_new_button="1" hide_delete_button="1" colors="red:priority=='emergency';darkgreen:priority=='urgent';blue:priority=='medium'">
					<field name="display_confirm_button" invisible="True" />
					<field name="procurement_request" invisible="True" />
					<field name="name" invisible="True" />
					<field name="sale_order_id" />
					<field name="priority" />
					<field name="categ" />
					<field name="line_number" />
					<field name="sale_order_state" />
					<field name="state" invisible="True" />
					<field name="product_id" />
					<field name="qty" string="Qty" />
					<field name="uom_id" /> 
                                        <button name="open_split_wizard" type="object" string="Split line" icon="terp-stock_effects-object-colorize" 
						attrs="{'invisible': [('display_confirm_button', '=', False)]}" />
					<field name="rts" />
					<field name="type" string="Proc. Method" on_change="onChangeType(type)" attrs="{'readonly': [('state', '!=', 'draft')]}" />
					<field name="po_cft"
						on_change="onChangePoCft(po_cft, company_id, procurement_request)" 
						attrs="{'readonly': ['|', ('type', '=', 'make_to_stock'), ('state', '!=', 'draft')], 'required': [('type', '=', 'make_to_order')]}" />
					<field name="real_stock" />
					<field name="available_stock" />
					<field name="virtual_stock" />
					<!-- do not work: attrs="{'readonly': ['|', '|', ('type', '=', 'make_to_stock'), '&amp;', ('type', '=', 'make_to_order'), ('po_cft', '=', 'cft'), ('state', '!=', 'draft')]}" -->
					<field name="company_id" invisible="1" />
					<field name="supplier" colspan="2"
						domain="[('id', '!=', company_id)]"
						context="{'product_id': product_id, 'choose_supplier': True}"
						attrs="{'readonly': ['|', ('type', '=', 'make_to_stock'), ('state', '!=', 'draft')]}"
						on_change="onChangeSupplier(supplier)" />
					<field name="customer" invisible="1" />
					<field name="estimated_delivery_date" />
					<button name="confirmLine" string="Source Line" icon="gtk-go-forward" type="object" attrs="{'invisible':[('display_confirm_button', '=', False)]}" />
					<!-- does not work. openerp bug ? <button name="unconfirmLine" string="Unconfirm Line" icon="gtk-cancel" type="object" attrs="{'invisible':['|', ('state', '!=', 'confirmed'), ('sale_order_state', '!=', 'draft')]}" />--> 

				</tree>
			</field>
		</record>

		<record id="sourcing_line_search_form_view" model="ir.ui.view">
			<field name="name">sourcing.line.search.form</field>
			<field name="model">sourcing.line</field>
			<field name="type">search</field>
			<field name="arch" type="xml">
				<search string="Sourcing Line">
				
					<!-- <filter name="need_sourcing" string="Need Sourcing" icon="gtk-indent" domain="[('display_confirm_button', '=', True)]" /> -->
					<filter name="need_sourcing" string="Need Sourcing" icon="terp-stock_zoom" domain="[('need_sourcing', '=', True)]" />
					<filter name="sourced" string="Sourced" icon="terp-camera_test" domain="['&amp;', '|', ('state', '!=', 'draft'), ('procurement_request', '=', True), '|', ('sale_order_state', '!=', 'progress'), ('procurement_request', '=', False)]" />
					<separator orientation="vertical"/>
					<field name="sale_order_id" />
					<field name="priority" />
					<field name="categ" />
					<field name="sale_order_state_search" />
					<field name="product_id" />
					<field name="type" />
					<newline />
					<group expand="0" string="Group By..." colspan="11" col="11"
						groups="base.group_extended">
						<filter string="Sale Order" icon="terp-accessories-archiver" domain="[]"
							context="{'group_by':'sale_order_id'}" />
						<filter string="Priority" icon="terp-emblem-important"
							domain="[]" context="{'group_by':'priority'}" />
						<filter string="Category" icon="terp-stock_symbol-selection"
							domain="[]" context="{'group_by':'categ'}" />
						<filter string="Order State" icon="terp-rating-rated"
							domain="[]" context="{'group_by':'sale_order_state'}" />
						<filter string="Product" icon="terp-product"
							domain="[]" context="{'group_by':'product_id'}" />
						<filter string="Supplier" icon="terp-personal+"
							domain="[]" context="{'group_by':'supplier'}" />
						<filter string="Customer" icon="terp-personal-"
							domain="[]" context="{'group_by':'customer'}" />
					</group>
				</search>
			</field>
		</record>

		<record id="sourcing_line_action" model="ir.actions.act_window">
			<field name="name">Orders Sourcing Tool</field>
			<field name="res_model">sourcing.line</field>
			<field name="view_type">form</field>
			<field name="view_mode">tree,form</field>
			<field name="domain">[('sale_order_state','!=','procurement')]</field>
			<field name="context">{'search_default_need_sourcing': True}</field>
			<field name="search_view_id" ref="sourcing_line_search_form_view" />
		</record>

		<menuitem icon="STOCK_INDENT" action="sourcing_line_action" sequence="2"
			id="menu_sourcing_line" parent="base.menu_sales" />
			
		<act_window name="Auto POs creation"
		    res_model="procurement.order.compute.all"
		    src_model="sourcing.line"
		    view_mode="form"
		    target="new"
            key2="client_action_multi"
		    id="action_compute_schedulers_sourcing"/>

	</data>
</openerp>
