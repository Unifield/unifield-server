-
  In order to check date, I create some analytic accounts with inactivation date, an analytic distribution and some expense lines then I reallocate them under the inactive account
-
  I create CC1 analytic account without any ending date (begin from 3 of this month)
-
  !record {model: account.analytic.account, id: cc1}:
    name: Cost Center 1
    code: CC1
    type: normal
    category: OC
    date_start: !eval "'%s-%s-03' % (datetime.now().year + 10, datetime.now().month)"
-
  I create CC2 analytic account with dates between 3 and 10 of the month
-
  !record {model: account.analytic.account, id: cc2}:
    name: Cost Center 2
    code: CC2
    type: normal
    category: OC
    date_start: !eval "'%s-%s-03' % (datetime.now().year + 10, datetime.now().month)"
    date: !eval "'%s-%s-13' % (datetime.now().year + 10, datetime.now().month)"
-
  I create CC3 analytic account without any ending date (begin from 15 of this month)
-
  !record {model: account.analytic.account, id: cc3}:
    name: Cost Center 3
    code: CC3
    type: normal
    category: OC
    date_start: !eval "'%s-%s-15' % (datetime.now().year + 10, datetime.now().month)"
-
  I create FP1 analytic account
-
  !record {model: account.analytic.account, id: fp1}:
    name: Funding Pool 1
    code: FP1
    type: normal
    category: FUNDING
    date_start: !eval "'%s-%s-03' % (datetime.now().year + 10, datetime.now().month)"
    date: !eval "'%s-%s-10' % (datetime.now().year + 10, datetime.now().month)"
    cost_center_ids: [cc1, cc2, cc3]
    tuple_destination_account_ids: [tuple_operation_6101]
-
  I create an analytic distribution.
-
  !record {model: analytic.distribution, id: distrib_2}:
    name: Distribution for checking dates
-
  I add some lines to this distribution. First CC.
-
  !record {model: cost.center.distribution.line, id: cost_center_1}:
    name: CC Line 1
    analytic_id: cc1
    destination_id: analytic_account_destination_operation
    distribution_id: distrib_2
    percentage: 100.0
    currency_id: base.EUR
-
  Then I create a FP line linked to previous CC.
-
  !record {model: funding.pool.distribution.line, id: funding_pool_line_1}:
    name: FP Line 1
    analytic_id: analytic_account_msf_private_funds
    destination_id: analytic_account_destination_operation
    distribution_id: distrib_2
    cost_center_id: cc1
    percentage: 100.0
    currency_id: base.EUR
-
  I create an expense.
-
  !record {model: account.move, id: move30}:
    journal_id: account_journal_expenses_0
    name: move 30
    period_id: period1
    document_date: !eval "'%s-%s-17' % (datetime.now().year, datetime.now().month)"
    date: !eval "'%s-%s-17' % (datetime.now().year + 10, datetime.now().month)"
    currency_id: base.EUR
    line_id:
    - name: a product
      account_id: account_account_expense0
      debit: 123.0
      credit: 0.0
      currency_id: base.EUR
      document_date: !eval "'%s-%s-17' % (datetime.now().year, datetime.now().month)"
      date: !eval "'%s-%s-17' % (datetime.now().year + 10, datetime.now().month)"
      analytic_distribution_id: distrib_2
    - name: counterpart
      account_id: account_account_payable_supplier0
      debit: 0.0
      credit: 123.0
      currency_id: base.EUR
      document_date: !eval "'%s-%s-17' % (datetime.now().year, datetime.now().month)"
      date: !eval "'%s-%s-17' % (datetime.now().year + 10, datetime.now().month)"
-
  I post this expense
-
  !python {model: account.move}: |
    self.post(cr, uid, ref('move30'))
-
  I check that an analytic lines have been created
-
  !python {model: account.analytic.line}: |
    al_ids = self.search(cr, uid, [('cost_center_id', '=', ref('cc1')), ('account_id', '=', ref('analytic_account_msf_private_funds')), ('general_account_id', '=', ref('account_account_expense0'))])
    assert len(al_ids) == 1, "Should have only 1 analytic line!"
-
  I reallocate the line to FP1 (which shouldn't be possible because it finish the 10, and the line is on 17).
-
  !python {model: mass.reallocation.wizard}: |
    ana_obj = self.pool.get('account.analytic.line')
    al_ids = ana_obj.search(cr, uid, [('cost_center_id', '=', ref('cc1')), ('account_id', '=', ref('analytic_account_msf_private_funds')), ('general_account_id', '=', ref('account_account_expense0'))])
    if isinstance(al_ids, (int, long)):
      al_ids = [al_ids]
    wiz_id = self.create(cr, uid, {'account_id': ref('fp1'), 'line_ids': [(6, 0, x) for x in [al_ids]], })
    res = self.button_validate(cr, uid, wiz_id)
    # Should have this: {'view_mode': 'form', 'res_id': [1], 'name': 'Verification Result', 'context': {}, 'view_type': 'form', 'res_model': 'mass.reallocation.verification.wizard', 'type': 'ir.actions.act_window', 'target': 'new'}
    next_obj = res.get('res_model', False) and self.pool.get(res.get('res_model')) or False
    next_id = res.get('res_id', False) and res.get('res_id') or False
    assert next_obj != False, "No result for mass reallocation wizard!"
    assert next_id != False, "No wizard for mass reallocation check!"
    from osv import osv
    error = None
    try:
      next_obj.button_validate(cr, uid, next_id)
    except osv.except_osv, e:
      error = e.value
    finally:
      assert error == 'No lines to be processed.', "Problem with given error: %s" % (error or '')
-
  I change so CC1 to CC2, in order to see if wizard refuse it.
-
  !python {model: mass.reallocation.wizard}: |
    ana_obj = self.pool.get('account.analytic.line')
    al_ids = ana_obj.search(cr, uid, [('cost_center_id', '=', ref('cc1')), ('account_id', '=', ref('analytic_account_msf_private_funds')), ('general_account_id', '=', ref('account_account_expense0'))])
    if isinstance(al_ids, (int, long)):
      al_ids = [al_ids]
    wiz_id = self.create(cr, uid, {'account_id': ref('cc2'), 'line_ids': [(6, 0, x) for x in [al_ids]], })
    res = self.button_validate(cr, uid, wiz_id)
    # Should have this: {'view_mode': 'form', 'res_id': [1], 'name': 'Verification Result', 'context': {}, 'view_type': 'form', 'res_model': 'mass.reallocation.verification.wizard', 'type': 'ir.actions.act_window', 'target': 'new'}
    next_obj = res.get('res_model', False) and self.pool.get(res.get('res_model')) or False
    next_id = res.get('res_id', False) and res.get('res_id') or False
    assert next_obj != False, "No result for mass reallocation wizard!"
    assert next_id != False, "No wizard for mass reallocation check!"
    from osv import osv
    error = None
    try:
      next_obj.button_validate(cr, uid, next_id)
    except osv.except_osv, e:
      error = e.value
    finally:
      assert error == 'No lines to be processed.', "Problem with given error: %s" % (error or '')
-
  Finally, I change CC1 to CC3, in order to see if wizard ACCEPT IT.
-
  !python {model: mass.reallocation.wizard}: |
    ana_obj = self.pool.get('account.analytic.line')
    al_ids = ana_obj.search(cr, uid, [('cost_center_id', '=', ref('cc1')), ('account_id', '=', ref('analytic_account_msf_private_funds')), ('general_account_id', '=', ref('account_account_expense0'))])
    if isinstance(al_ids, (int, long)):
      al_ids = [al_ids]
    # I change analytic lines document date
    from datetime import datetime
    for al in ana_obj.browse(cr, uid, al_ids):
      ana_obj.write(cr, uid, al_ids, {'document_date': '%s-%s-01' % (datetime.now().year, datetime.now().month), })
    wiz_id = self.create(cr, uid, {'account_id': ref('cc3'), 'line_ids': [(6, 0, x) for x in [al_ids]], })
    res = self.button_validate(cr, uid, wiz_id)
    # Should have this: {'view_mode': 'form', 'res_id': [1], 'name': 'Verification Result', 'context': {}, 'view_type': 'form', 'res_model': 'mass.reallocation.verification.wizard', 'type': 'ir.actions.act_window', 'target': 'new'}
    next_obj = res.get('res_model', False) and self.pool.get(res.get('res_model')) or False
    next_id = res.get('res_id', False) and res.get('res_id') or False
    assert next_obj != False, "No result for mass reallocation wizard!"
    assert next_id != False, "No wizard for mass reallocation check!"
    from osv import osv
    error = None
    try:
      next_obj.button_validate(cr, uid, next_id)
    except osv.except_osv, e:
      error = e.value
    finally:
      assert error is None, "Error occured: %s" % (error or '')
