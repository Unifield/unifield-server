- 
  Creating a sale.order record A
- 
  !record {model: sale.order, id: outgoing_so_A}:
    amount_tax: 0.0
    amount_total: 1.0
    amount_untaxed: 1.0
    company_id: base.main_company
    date_order: '2011-04-13'
    invoice_quantity: order
    order_policy: manual
    partner_id: outgoing_partner_A
    partner_invoice_id: outgoing_address_A
    partner_order_id: outgoing_address_A
    partner_shipping_id: outgoing_address_A
    picking_policy: direct
    pricelist_id: product.list0
    shop_id: sale.shop
    priority: normal
    categ: medical
- 
  Creating a sale.order.line record A1
- 
  !record {model: sale.order.line, id: outgoing_sol_A1}:
    company_id: base.main_company
    delay: 7.0
    name: P
    order_id: outgoing_so_A
    price_unit: 1.0
    product_id: outgoing_product_A
    product_uom: product.product_uom_unit
    product_uom_qty: 100
    salesman_id: base.user_admin
    state: draft
    th_weight: 0.0
    type: make_to_stock
- 
  Creating a sale.order.line record A2
- 
  !record {model: sale.order.line, id: outgoing_sol_A2}:
    company_id: base.main_company
    delay: 7.0
    name: P
    order_id: outgoing_so_A
    price_unit: 1.0
    product_id: outgoing_product_B
    product_uom: product.product_uom_unit
    product_uom_qty: 200
    salesman_id: base.user_admin
    state: draft
    th_weight: 0.0
    type: make_to_stock
- 
  Creating a sale.order record B
- 
  !record {model: sale.order, id: outgoing_so_B}:
    amount_tax: 0.0
    amount_total: 1.0
    amount_untaxed: 1.0
    company_id: base.main_company
    date_order: '2011-04-13'
    invoice_quantity: order
    order_policy: manual
    partner_id: outgoing_partner_A
    partner_invoice_id: outgoing_address_A
    partner_order_id: outgoing_address_A
    partner_shipping_id: outgoing_address_A
    picking_policy: direct
    pricelist_id: product.list0
    shop_id: sale.shop
    priority: normal
    categ: medical
- 
  Creating a sale.order.line record A
- 
  !record {model: sale.order.line, id: outgoing_sol_B1}:
    company_id: base.main_company
    delay: 7.0
    name: P
    order_id: outgoing_so_B
    price_unit: 1.0
    product_id: outgoing_product_A
    product_uom: product.product_uom_unit
    product_uom_qty: 100
    salesman_id: base.user_admin
    state: draft
    th_weight: 0.0
    type: make_to_stock
- 
  Creating a sale.order.line record B
- 
  !record {model: sale.order.line, id: outgoing_sol_B2}:
    company_id: base.main_company
    delay: 7.0
    name: P
    order_id: outgoing_so_B
    price_unit: 1.0
    product_id: outgoing_product_B
    product_uom: product.product_uom_unit
    product_uom_qty: 200
    salesman_id: base.user_admin
    state: draft
    th_weight: 0.0
    type: make_to_stock
-
  I validate the sale order
-
  !python {model: sale.order}: |
    import netsvc
    wf_service = netsvc.LocalService("workflow")
    wf_service.trg_validate(uid, 'sale.order', ref("outgoing_so_A"), 'order_confirm', cr)
    
-

  I check the draft picking creation and create picking object

-
  !python {model: stock.picking}: |
    ids = self.search(cr, uid, [('sale_id', '=', ref("outgoing_so_A")), ('state', '=', 'draft')], context=context)
    assert len(ids) == 1, 'number of created draft picking is wrong, 1 - %s'%len(ids)
    res = self.create_picking(cr, uid, ids, context=context)
    model = res['res_model']
    id = res['res_id']
    # update the context
    self.pool.get(model).do_create_picking(cr, uid, [id], context=res['context'])
    
-

  I check the picking creation, change the flow_type to 'quick' and validate it

-
  !python {model: stock.picking}: |
    ids = self.search(cr, uid, [('sale_id', '=', ref("outgoing_so_A")), ('state', '=', 'assigned')], context=context)
    assert len(ids) == 1, 'number of created draft picking is wrong, 1 - %s'%len(ids)
    # update flow_type
    self.write(cr, uid, ids, {'flow_type': 'quick',}, context=context)
    res = self.validate_picking(cr, uid, ids, context=context)
    model = res['res_model']
    id = res['res_id']
    # update the context
    self.pool.get(model).do_validate_picking(cr, uid, [id], context=res['context'])
    
-

  I check the ppl creation, shipment draft and create a new shipment, ship it, validate it, and check
  that draft shipment is done

-
  !python {model: shipment}: |
    ids = self.search(cr, uid, [('state', '=', 'draft'), ('address_id', '=', ref("outgoing_address_A"))], context=context)
    assert len(ids) == 1, 'number of created draft shipment is wrong, 1 - %s'%len(ids)
    
    # create a new shipment
    res = self.create_shipment(cr, uid, ids, context=context)
    model = res['res_model']
    id = res['res_id']
    # update the context
    self.pool.get(model).do_create_shipment(cr, uid, [id], context=res['context'])
    # ship it
    ids = self.search(cr, uid, [('state', '=', 'packed'), ('address_id', '=', ref("outgoing_address_A"))], context=context)
    assert len(ids) == 1, 'number of created shipment is wrong, 1 - %s'%len(ids)
    self.ship(cr, uid, ids, context=context)
    # validate it
    self.validate(cr, uid, ids, context=context)
    # shipment done
    assert self.browse(cr, uid, ids[0], context=context).state == 'done', 'state is wrong for validated shipment - done - %s'%self.browse(cr, uid, ids[0], context=context).state
    assert self.browse(cr, uid, ids[0], context=context).backshipment_id.state == 'done', 'state is wrong for draft shipment - done - %s'%self.browse(cr, uid, ids[0], context=context).backshipment_id.state
    
-

  I check the ppl creation, shipment draft and create a new shipment, ship it, validate it, and check
  that draft shipment is done

-
  !python {model: stock.picking}: |
    ids = self.search(cr, uid, [('sale_id', '=', ref("outgoing_so_A")),], context=context)
    # we must have 6 objects - draft picking - picking - ppl - draft packing - packing (packed) - packing (shipped)
    objects = ['draft_picking', 'picking', 'ppl', 'draft_packing', 'packing_packed', 'packing_shipped']
    assert len(ids) == len(objects), 'the number of picking objects is wrong - %s - %s'%(len(objects), len(ids))
    assert all([p.state == 'done' for p in self.browse(cr, uid, ids, context=context)]), 'all corresponding picking objects are not done - %s'%[p.state == 'done' for p in self.browse(cr, uid, ids, context=context)]
